/**
 * Add a create new group modal to the page.
 *
 * @module     local_learningplan/learningplan
 * @class      courseenrol
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_learningplan/courseenrol",["jquery","core/str","core/modal_factory","core/modal_events","core/fragment","core/ajax","core/yui","local_learningplan/jquery.dataTables"],(function($,Str,ModalFactory,ModalEvents,Fragment,Ajax,Y){var courseenrol=function(args){this.args=args,this.contextid=args.contextid,this.planid=args.planid,this.condition=args.condition;this.init(args.selector)};return courseenrol.prototype.modal=null,courseenrol.prototype.contextid=-1,courseenrol.prototype.init=function(){var self=this;return Str.get_string("enrolcourses","local_learningplan").then(function(title){return ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:title,body:self.getBody()})}.bind(self)).then(function(modal){return self.modal=modal,self.modal.getRoot().addClass("openLMStransition local_costcenter"),self.modal.setLarge(),self.modal.getRoot().on(ModalEvents.hidden,function(){self.modal.setBody(self.getBody()),self.modal.getRoot().animate({right:"-85%"},500),setTimeout((function(){modal.destroy()}),1e3)}.bind(this)),this.modal.getFooter().find('[data-action="cancel"]').on("click",(function(){window.location.href()})),self.modal.getRoot().on(ModalEvents.shown,function(){self.modal.getRoot().append("<style>[data-fieldtype=submit] { display: none ! important; }</style>")}.bind(this)),self.modal.getRoot().on(ModalEvents.save,self.submitForm.bind(self)),self.modal.getRoot().on("submit","form",self.submitFormAjax.bind(self)),this.modal.show(),this.modal.getRoot().animate({right:"0%"},500),$(".close").click((function(){window.location=window.location.href})),this.modal}.bind(this))},courseenrol.prototype.getBody=function(formdata){void 0===formdata&&(formdata={});var params={planid:this.planid,jsonformdata:JSON.stringify(formdata),condition:this.condition};return Fragment.loadFragment("local_learningplan","lpcourse_enrol",this.contextid,params)},courseenrol.prototype.handleFormSubmissionResponse=function(){this.modal.hide(),Y.use("moodle-core-formchangechecker",(function(){M.core_formchangechecker.reset_form_dirty_state()})),document.location.reload()},courseenrol.prototype.handleFormSubmissionFailure=function(data){this.modal.setBody(this.getBody(data))},courseenrol.prototype.submitFormAjax=function(e){e.preventDefault();var formData=this.modal.getRoot().find("form").serialize();Ajax.call([{methodname:"local_learningplan_lpcourse_enrol_form",args:{planid:this.planid,contextid:this.contextid,jsonformdata:JSON.stringify(formData)},done:this.handleFormSubmissionResponse.bind(this,formData),fail:this.handleFormSubmissionFailure.bind(this,formData)}])},courseenrol.prototype.submitForm=function(e){e.preventDefault();this.modal.getRoot().find("form").submit()},{init:function(args){return new courseenrol(args)},load:function(){$(document).on("click",".unenrolself_module",(function(){var args=$(this).data();return Str.get_strings([{key:"confirm",component:"moodle"},{key:args.identifier,component:args.plugin,param:args},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).then(function(s){ModalFactory.create({title:s[0],type:ModalFactory.types.SAVE_CANCEL,body:s[1]}).done(function(modal){this.modal=modal,modal.setSaveButtonText(s[2]),modal.getRoot().on(ModalEvents.save,function(e){e.preventDefault();var params={};params.id=args.id,params.contextid=args.contextid,params.userid=args.userid,Ajax.call([{methodname:args.pluginname+"_"+args.methodname,args:params}])[0].done((function(){window.location=window.location.href})).fail((function(){}))}.bind(this)),modal.show()}.bind(this))}.bind(this))}))},publishLearningplan:function(args){var planvalue=args.planid;return Str.get_strings([{key:"confirm"},{key:"learningplan_enrol_users",component:"local_learningplan",param:args},{key:"confirmall",component:"local_learningplan"},{key:"confirm"}]).then(function(s){ModalFactory.create({title:s[0],type:ModalFactory.types.SAVE_CANCEL,body:s[1]}).done(function(modal){this.modal=modal,modal.setSaveButtonText(s[3]),modal.getRoot().on(ModalEvents.save,function(e){e.preventDefault();var params="?action=publishlearningplan&planid="+planvalue;$.ajax({method:"GET",dataType:"json",url:M.cfg.wwwroot+"/local/learningplan/ajax.php"+params,success:function(){window.location=window.location.href}})}.bind(this)),modal.show()}.bind(this))}.bind(this))},tabsFunction:function(){$(".learningplan_tabs").click((function(){if($(this).find("a").hasClass("active"))return!0;var learningplantab=$(this).data("module"),id=$(this).data("id"),options=$(this).data("options"),dataoptions=$(this).data("dataoptions"),filterdata=$(this).data("filterdata");$.ajax({method:"GET",url:M.cfg.wwwroot+"/local/learningplan/ajax.php",data:{action:"learningplantab",tab:learningplantab,id:id,ajax:0},success:function(resp){var html=resp;if($("#learningplantabscontent").html(html),$("#learningplantabscontent").find("div").addClass("active"),"users"==learningplantab){var params=[];return params.action="learningplantab",params.tab="users",params.id=id,params.ajax=1,Str.get_strings([{key:"search",component:"moodle"}]).then(function(s){$("table#learning_plan_users").dataTable({processing:!0,serverSide:!0,language:{paginate:{next:">",previous:"<"},search:"",searchPlaceholder:s[0],processing:"<img src="+M.cfg.wwwroot+"/local/ajax-loader.svg>"},ajax:{type:"POST",url:M.cfg.wwwroot+"/local/learningplan/ajax.php",data:params},responsive:!0,pageLength:5,bLengthChange:!1,bInfo:!1})}.bind(this))}"requestedusers"==learningplantab&&require(["local_costcenter/cardPaginate"],(function(cardPaginate){cardPaginate.reload(options,dataoptions,filterdata)}))}})}))},enrolUser:function(args){var planvalue=args.planid,userid=args.userid;return Str.get_strings([{key:"confirm"},{key:"learningplan_self_enrol",component:"local_learningplan",param:args},{key:"confirm"}]).then(function(s){ModalFactory.create({title:s[0],type:ModalFactory.types.SAVE_CANCEL,body:s[1]}).done(function(modal){this.modal=modal,modal.setSaveButtonText(s[2]),modal.getRoot().on(ModalEvents.save,function(e){e.preventDefault();var path=M.cfg.wwwroot+"/local/learningplan/ajax.php?";$.ajax({method:"GET",dataType:"json",url:path+"action=userselfenrol&planid="+planvalue+"&userid="+userid,success:function(){modal.destroy(),window.location.href=M.cfg.wwwroot+"/local/learningplan/view.php?id="+planvalue}})}.bind(this)),modal.show()}.bind(this))}.bind(this))},unEnrolUser:function(args){return Str.get_strings([{key:"confirm"},{key:"learningplan_self_unenrol",component:"local_learningplan",param:args}]).then(function(s){ModalFactory.create({title:s[0],type:ModalFactory.types.SAVE_CANCEL,body:s[1]}).done(function(modal){this.modal=modal,modal.setSaveButtonText(s[0]),modal.getRoot().on(ModalEvents.save,function(e){e.preventDefault();var params={};params.userid=args.userid,params.planid=args.planid,Ajax.call([{methodname:"local_learningplan_unassign_user",args:params}])[0].done((function(){window.location.href=M.cfg.wwwroot})).fail((function(){}))}.bind(this)),modal.show()}.bind(this))}.bind(this))}}}));

//# sourceMappingURL=courseenrol.min.js.map