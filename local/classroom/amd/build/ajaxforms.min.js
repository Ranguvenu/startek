/**
 * Add a create new group modal to the page.
 *
 * @module     core_group/AjaxForms
 * @class      AjaxForms
 * @package    core_group
 * @copyright  2017 Damyon Wiese <damyon@moodle.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_classroom/ajaxforms",["jquery","core/str","core/modal_factory","core/modal_events","core/fragment","core/ajax","core/yui","core/templates","local_classroom/select2","local_classroom/classroom"],(function($,Str,ModalFactory,ModalEvents,Fragment,Ajax,Y,Templates,select2,Classroom){classroomlastchildpopup=function(args){params={classroomid:args.id,contextid:1},Ajax.call([{methodname:"local_classroom_classroomlastchildpopup",args:params}])[0].done((function(returndata){Templates.render("local_classroom/classroomview",{response:returndata}).then((function(response){ModalFactory.create({title:Str.get_string("classroom_info","local_classroom"),body:response}).done((function(modal){modal.show(),modal.setLarge(),modal.getRoot().addClass("openLMStransition"),modal.getRoot().animate({right:"0%"},500),modal.getRoot().on(ModalEvents.hidden,function(){modal.getRoot().animate({right:"-85%"},500),setTimeout((function(){modal.destroy()}),1e3)}.bind(this)),$(".close").click((function(){window.location.href=window.location.href}))}))}))})).fail((function(ex){console.log(ex)}))};var AjaxForms=function(args){this.contextid=args.contextid,this.args=args,this.init(args)};return AjaxForms.prototype.modal=null,AjaxForms.prototype.contextid=-1,AjaxForms.prototype.init=function(args){var self=this;switch(args.callback){case"classroom_form":if(0===args.id)var head={key:"createclassroom",component:"local_classroom"};else head={key:"updateclassroom",component:"local_classroom"};break;case"session_form":if(0===args.id)head={key:"addsession",component:"local_classroom"};else head={key:"updatesession",component:"local_classroom"};break;case"course_form":if(0===args.id)head={key:"addcourses",component:"local_classroom"};else head={key:"updatecourses",component:"local_classroom"};break;case"classroom_completion_form":head={key:"classroom_completion_settings",component:"local_classroom"}}return customstrings=Str.get_strings([head,{key:"savecontinue",component:"local_classroom"},{key:"assign",component:"local_classroom"},{key:"save",component:"local_classroom"},{key:"previous",component:"local_classroom"},{key:"skip",component:"local_classroom"},{key:"cancel",component:"local_classroom"}]),customstrings.then(function(strings){return ModalFactory.create({type:ModalFactory.types.DEFAULT,title:strings[0],body:this.getBody(),footer:this.getFooter(strings)})}.bind(this)).then(function(modal){return this.modal=modal,this.modal.setLarge(),this.modal.getRoot().addClass("openLMStransition local_classroom"),this.modal.getRoot().on(ModalEvents.hidden,function(){this.modal.getRoot().animate({right:"-85%"},500),setTimeout((function(){modal.destroy()}),1e3)}.bind(this)),this.modal.getFooter().find('[data-action="save"]').on("click",this.submitForm.bind(this)),this.modal.getFooter().find('[data-action="cancel"]').on("click",(function(){window.location.href=window.location.href})),this.modal.getFooter().find('[data-action="skip"]').on("click",(function(){self.args.form_status=self.args.form_status+1;var data=self.getBody();data.then((function(html,js){!1===html&&self.handleFormSubmissionResponse(args)})),modal.setBody(data),3==self.args.form_status&&$('[data-action="skip"]').css("display","none")})),this.modal.getFooter().find('[data-action="previous"]').on("click",(function(){self.args.form_status=self.args.form_status-1;var data=self.getBody();data.then((function(html,js){!1===html&&self.handleFormSubmissionResponse(args)})),modal.setBody(data),0==self.args.form_status?($('[data-action="skip"]').css("display","none"),$('[data-action="previous"]').css("display","none")):self.args.form_status<3&&($('[data-action="skip"]').css("display","inline-block"),$('[data-action="previous"]').css("display","inline-block"))})),"classroom_form"==self.args.callback&&$(document).on("click",".custom_classroom_form_redirect",(function(){if($("#classroomid").val()>0){self.args.form_status=$(this).data("value");var data=self.getBody();data.then((function(html,js){!1===html&&self.handleFormSubmissionResponse(args)})),modal.setBody(data),0==self.args.form_status?($('[data-action="skip"]').css("display","none"),$('[data-action="previous"]').css("display","none")):self.args.form_status<4&&($('[data-action="skip"]').css("display","inline-block"),$('[data-action="previous"]').css("display","inline-block"))}})),this.modal.getRoot().on("submit","form",(function(form){self.submitFormAjax(form,self.args)})),this.modal.show(),this.modal.getRoot().animate({right:"0%"},500),$(".close").click((function(){window.location.href=window.location.href})),this.modal}.bind(this))},AjaxForms.prototype.getBody=function(formdata){return void 0===formdata&&(formdata={}),this.args.jsonformdata=JSON.stringify(formdata),Fragment.loadFragment(this.args.component,this.args.callback,this.contextid,this.args)},AjaxForms.prototype.getFooter=function(customstrings){var footer="",style='style="display:none;"';return"classroom_form"==this.args.callback?footer+='<button type="button" class="btn btn-primary" data-action="save">'+customstrings[1]+"</button>&nbsp;":"course_form"==this.args.callback?footer+='<button type="button" class="btn btn-primary" data-action="save">'+customstrings[2]+"</button>&nbsp;":footer+='<button type="button" class="btn btn-primary" data-action="save">'+customstrings[3]+"</button>&nbsp;",0==this.args.form_status&&(footer+='<button type="button" class="btn btn-secondary" data-action="previous" '+style+">"+customstrings[4]+"</button>&nbsp;",footer+='<button type="button" class="btn btn-secondary" data-action="skip" '+style+">"+customstrings[5]+"</button>&nbsp;"),footer+='<button type="button" class="btn btn-secondary" data-action="cancel">'+customstrings[6]+"</button>"},AjaxForms.prototype.handleFormSubmissionResponse=function(args){this.modal.hide(),Y.use("moodle-core-formchangechecker",(function(){M.core_formchangechecker.reset_form_dirty_state()})),-2!=args.form_status&&3!=args.form_status&&"course_form"!=args.callback||window.location.reload(),classroomlastchildpopup(args)},AjaxForms.prototype.handleFormSubmissionFailure=function(data){this.modal.setBody(this.getBody(data))},AjaxForms.prototype.submitFormAjax=function(e,args){e.preventDefault();var self=this,formData=this.modal.getRoot().find("form").serialize(),methodname=args.plugintype+"_"+args.pluginname+"_submit_instance",params={};params.contextid=this.contextid,params.jsonformdata=JSON.stringify(formData),params.form_status=args.form_status,Ajax.call([{methodname:methodname,args:params}])[0].done((function(resp){self.args.form_status=resp.form_status,resp.form_status>=0&&!1!==resp.form_status?(self.args.form_status=resp.form_status,self.args.id=resp.id,self.handleFormSubmissionFailure()):(self.handleFormSubmissionResponse(self.args),window.location.reload()),args.form_status>0&&($('[data-action="skip"]').css("display","inline-block"),$('[data-action="previous"]').css("display","inline-block")),3==args.form_status&&$('[data-action="skip"]').css("display","none")})).fail((function(ex){self.handleFormSubmissionFailure(formData)}))},AjaxForms.prototype.submitForm=function(e){e.preventDefault(),this.modal.getRoot().find("form").submit()},{init:function(args){return new AjaxForms(args)},load:function(){$(document).on("click",'#fitem_id_department .form-autocomplete-selection .badge.badge-info, #fitem_id_department .form-autocomplete-suggestions [role="option"]',(function(){$("#fitem_id_subdepartment .form-autocomplete-selection .badge.badge-info").trigger("click")}))}}}));

//# sourceMappingURL=ajaxforms.min.js.map