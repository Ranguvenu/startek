{"version":3,"file":"positiontable.min.js","sources":["../src/positiontable.js"],"sourcesContent":["define([\r\n    'local_positions/jquery.dataTables',\r\n    'core/str',\r\n    'core/modal_factory',\r\n    'core/modal_events',\r\n    'core/ajax',\r\n    'core/fragment',\r\n    'jquery',\r\n    'jqueryui',\r\n], function (dataTable, Str, ModalFactory, ModalEvents, Ajax, Fragment, $) {\r\n    var Newposition = function(args){\r\n            this.args = args;\r\n            var self = this;\r\n            self.init(args);\r\n        };\r\n\r\n        /**\r\n         * @var {Modal} modal\r\n         * @private\r\n         */\r\n        Newposition.prototype.modal = null;\r\n     \r\n        /**\r\n         * @var {int} contextid\r\n         * @private\r\n         */\r\n        Newposition.prototype.contextid = -1;\r\n\r\n        Newposition.prototype.init = function(args) {\r\n            // console.log(args);\r\n            //var triggers = $(selector);\r\n            var self = this;\r\n            if(args.positionid){\r\n                var head = Str.get_string('editposition', 'local_positions');\r\n            }else{\r\n                var head = Str.get_string('createposition', 'local_positions');\r\n            }\r\n            return head.then(function(title) {\r\n                // Create the modal.\r\n                return ModalFactory.create({\r\n                    type: ModalFactory.types.SAVE_CANCEL,\r\n                    title: title,\r\n                    body: self.getBody()\r\n                });\r\n            }.bind(self)).then(function(modal) {\r\n                    \r\n                // Keep a reference to the modal.\r\n                self.modal = modal;\r\n                // Forms are big, we want a big modal.\r\n                self.modal.setLarge();\r\n                this.modal.getRoot().addClass('openLMStransition local_positions');\r\n     \r\n                // We want to reset the form every time it is opened.\r\n                this.modal.getRoot().on(ModalEvents.hidden, function() {\r\n                    this.modal.getRoot().animate({\"right\":\"-85%\"}, 500);\r\n                    setTimeout(function(){\r\n                        modal.destroy();\r\n                    }, 100);\r\n                }.bind(this));\r\n                // self.modal.getRoot().on(ModalEvents.hidden, function() {\r\n                //     modal.hide();\r\n                //         setTimeout(function(){\r\n                //             modal.destroy();\r\n                //         }, 5000);\r\n                //     //     self.modal.setBody(self.getBody());\r\n                //     }.bind(this));\r\n                        self.modal.getRoot().on(ModalEvents.shown, function() {\r\n                        self.modal.getRoot().append('<style>[data-fieldtype=submit] { display: none ! important; }</style>');\r\n                        this.modal.getFooter().find('[data-action=\"cancel\"]').on('click', function() {\r\n                            modal.hide();\r\n                            setTimeout(function(){\r\n                                modal.destroy();\r\n                            }, 100);\r\n                            // modal.destroy();\r\n                        });\r\n                    }.bind(this));\r\n        \r\n                    // We catch the modal save event, and use it to submit the form inside the modal.\r\n                    // Triggering a form submission will give JS validation scripts a chance to check for errors.\r\n                    self.modal.getRoot().on(ModalEvents.save, self.submitForm.bind(self));\r\n                    // We also catch the form submit event and use it to submit the form with ajax.\r\n                    self.modal.getRoot().on('submit', 'form', self.submitFormAjax.bind(self));\r\n                    self.modal.show();\r\n                    this.modal.getRoot().animate({\"right\":\"0%\"}, 500);\r\n                    return this.modal;\r\n                }.bind(this));       \r\n            \r\n            \r\n            // });\r\n            \r\n        };\r\n\r\n         /**\r\n         * @method getBody\r\n         * @private\r\n         * @return {Promise}\r\n         */\r\n        Newposition.prototype.getBody = function(formdata) {\r\n            if (typeof formdata === \"undefined\") {\r\n                formdata = {};\r\n            }\r\n            // Get the content of the modal.\r\n            var params = {positionid:this.args.positionid, jsonformdata: JSON.stringify(formdata)};\r\n            return Fragment.loadFragment('local_positions', 'position_form', this.args.contextid, params);\r\n        \r\n        };\r\n\r\n        /**\r\n         * @method handleFormSubmissionResponse\r\n         * @private\r\n         * @return {Promise}\r\n         */\r\n        Newposition.prototype.handleFormSubmissionResponse = function() {\r\n            this.modal.hide();\r\n            // We could trigger an event instead.\r\n            // Yuk.\r\n            Y.use('moodle-core-formchangechecker', function() {\r\n                M.core_formchangechecker.reset_form_dirty_state();\r\n            });\r\n            document.location.reload();\r\n        };\r\n\r\n        /**\r\n         * @method handleFormSubmissionFailure\r\n         * @private\r\n         * @return {Promise}\r\n         */\r\n        Newposition.prototype.handleFormSubmissionFailure = function(data) {\r\n            // Oh noes! Epic fail :(\r\n            // Ah wait - this is normal. We need to re-display the form with errors!\r\n            this.modal.setBody(this.getBody(data));\r\n        };\r\n        \r\n        /**\r\n         * Private method\r\n         *\r\n         * @method submitFormAjax\r\n         * @private\r\n         * @param {Event} e Form submission event.\r\n         */\r\n        Newposition.prototype.submitFormAjax = function(e) {\r\n            // We don't want to do a real form submission.\r\n            e.preventDefault();\r\n     \r\n            // Convert all the form elements values to a serialised string.\r\n            var formData = this.modal.getRoot().find('form').serialize();\r\n            \r\n            // Now we can continue...\r\n            Ajax.call([{\r\n                methodname: 'local_positions_submit_position_form',\r\n                args: {contextid: this.args.contextid, jsonformdata: formData},\r\n                done: this.handleFormSubmissionResponse.bind(this, formData),\r\n                fail: this.handleFormSubmissionFailure.bind(this, formData)\r\n            }]);\r\n        };\r\n\r\n        /**\r\n         * This triggers a form submission, so that any mform elements can do final tricks before the form submission is processed.\r\n         *\r\n         * @method submitForm\r\n         * @param {Event} e Form submission event.\r\n         * @private\r\n         */\r\n        Newposition.prototype.submitForm = function(e) {\r\n            e.preventDefault();\r\n            var self = this;\r\n            self.modal.getRoot().find('form').submit();\r\n        };\r\n    return{\r\n        init: function(args){\r\n            return new Newposition(args);\r\n        },\r\n        load: function(){\r\n        },\r\n        positiontable: function(){\r\n            $(\"#all_positions_display_table\").dataTable({\r\n                \"processing\": true,\r\n                \"bServerSide\": true,\r\n                \"sAjaxSource\":M.cfg.wwwroot + \"/local/positions/ajax.php?action=getpositionstable\",\r\n                \"aaSorting\": [],\r\n                \"pageLength\": 10,\r\n            });\r\n            $(\"#all_positions_display_table\").css('width', '100%');\r\n        },\r\n        deleteposition: function(args){\r\n            if(args.positiontype == 'parentposition')  {\r\n                var deletemessage = 'deleteparentpositionconfirm';\r\n            } else {\r\n                var deletemessage = 'deletepositionconfirm';\r\n            }\r\n            return Str.get_strings([{\r\n                key: 'confirm'\r\n            },\r\n            {\r\n                key: deletemessage,\r\n                component: 'local_positions',\r\n                param :args\r\n            },\r\n            {\r\n                key: 'delete'\r\n            }]).then(function(s) {\r\n                ModalFactory.create({\r\n                    title: s[0],\r\n                    type: ModalFactory.types.SAVE_CANCEL,\r\n                    body: s[1]\r\n                }).done(function(modal) {\r\n                    this.modal = modal;\r\n                    //modal.setSaveButtonText(s[2]);\r\n                    modal.setSaveButtonText(Str.get_string('yes_delete', 'local_positions'));\r\n\r\n\r\n                    //For cancel button string changed//\r\n                    var value=Str.get_string('cancel', 'local_positions');\r\n                    var button = this.modal.getFooter().find('[data-action=\"cancel\"]');\r\n                    this.modal.asyncSet(value, button.text.bind(button));\r\n                    \r\n                    modal.getRoot().on(ModalEvents.save, function(e) {\r\n                        e.preventDefault();\r\n                        args.confirm = true;\r\n                        $.ajax({\r\n                            method: \"POST\",\r\n                            dataType: \"json\",\r\n                            url: M.cfg.wwwroot + \"/local/positions/ajax.php?action=deleteposition&positionid=\"+args.positionid,\r\n                            success: function(data){\r\n                                if(args.positiontype == 'parentposition' && data == true)  {\r\n                                    window.location.href = M.cfg.wwwroot + \"/local/positions/domains.php\";\r\n                                }else{\r\n                                    window.location.reload();\r\n                                }\r\n\r\n                            }\r\n                        });\r\n                    }.bind(this));\r\n                    modal.show();\r\n                }.bind(this));\r\n            }.bind(this));\r\n\r\n        },\r\n        getposition: function() {\r\n            $(document).on('change', '#id_costcenter', function(){\r\n                var orgID = $(this).val();\r\n                var domainid = 0;\r\n                if(orgID>0){\r\n                    var promise = Ajax.call([{\r\n                        methodname: 'local_parent_positions',\r\n                        args: {\r\n                            orgid: orgID,\r\n                            domainid: domainid,\r\n                        },\r\n                    }]);\r\n                    promise[0].done(function(resp) {\r\n                        customstrings = Str.get_strings(\r\n                            [{\r\n                                key: 'selectparent',\r\n                                component: 'local_positions'\r\n                            }]);\r\n                        return customstrings.then(function(strings) {\r\n                            var template =  '<option value=\\'\\'>'+strings[0]+'</option>';\r\n                        });                                     \r\n                        $.each(JSON.parse(resp.parents), function( index, value) {\r\n                            template += '<option value = ' + index + ' >' +value + '</option>';\r\n                        });\r\n                        $('#id_parent').html(template);\r\n                        customstrings = Str.get_strings(\r\n                            [{\r\n                                key: 'selectdomain',\r\n                                component: 'local_positions'\r\n                            }]);\r\n                        return customstrings.then(function(strings) {\r\n                            var domain_template =  '<option value=\\'\\'>'+strings[0]+'</option>';\r\n                        });                                    \r\n                        $.each(JSON.parse(resp.domains), function( index, value) {\r\n                            domain_template += '<option value = ' + index + ' >' +value + '</option>';\r\n                        });\r\n                        $('#id_domain').html(domain_template);\r\n                    }).fail(function() {\r\n                        // do something with the exception\r\n                        alert('Error occured while processing request');\r\n                         window.location.reload();\r\n                    });\r\n                } else {\r\n                    customstrings = Str.get_strings(\r\n                            [\r\n                            {\r\n                                key: 'selectparent',\r\n                                component: 'local_positions'\r\n                            },\r\n                            {\r\n                                key: 'selectdomain',\r\n                                component: 'local_positions'\r\n                            }\r\n                            ]);\r\n                    return customstrings.then(function(strings) {\r\n                            var template =  '<option value=\\'\\'>'+strings[1]+'</option>';\r\n                            $('#id_domain').html(template);\r\n                            var template1 =  '<option value=\\'\\'>'+strings[0]+'</option>';\r\n                            $('#id_parent').html(template1);\r\n                     });\r\n                }\r\n            });\r\n            $(document).on('change', '#id_domain', function(){\r\n                var orgID = $('#id_costcenter').val();\r\n                if(orgID > 0) {\r\n                    orgID = orgID;\r\n                } else {\r\n                    orgID = $('input[name=costcenter]').val();\r\n                }\r\n                var domainId = $(this).val();\r\n                if(orgID>0 && domainId>0){\r\n                    var promise = Ajax.call([{\r\n                        methodname: 'local_parent_positions',\r\n                        args: {\r\n                            orgid: orgID,\r\n                            domainid: domainId,\r\n                        },\r\n                    }]);\r\n                    promise[0].done(function(resp) {\r\n                        customstrings = Str.get_strings(\r\n                            [{\r\n                                key: 'selectparent',\r\n                                component: 'local_positions'\r\n                            }]);\r\n                        return customstrings.then(function(strings) {\r\n                            var template =  '<option value=\\'\\'>'+strings[0]+'</option>';\r\n                        });                                     \r\n                        $.each(JSON.parse(resp.parents), function( index, value) {\r\n                            template += '<option value = ' + index + ' >' +value + '</option>';\r\n                        });\r\n                        $('#id_parent').html(template);\r\n                    }).fail(function() {\r\n                        // do something with the exception\r\n                        alert('Error occured while processing request');\r\n                         window.location.reload();\r\n                    });\r\n                } else {\r\n                    customstrings = Str.get_strings(\r\n                            [{\r\n                                key: 'selectparent',\r\n                                component: 'local_positions'\r\n                            }]);\r\n                    return customstrings.then(function(strings) {\r\n                            var template =  '<option value=\\'\\'>'+strings[0]+'</option>';\r\n                    }); \r\n                    $('#id_parent').html(template);\r\n                }\r\n           });\r\n        },\r\n    }\r\n});\r\n"],"names":["define","dataTable","Str","ModalFactory","ModalEvents","Ajax","Fragment","$","Newposition","args","this","init","prototype","modal","contextid","self","positionid","head","get_string","then","title","create","type","types","SAVE_CANCEL","body","getBody","bind","setLarge","getRoot","addClass","on","hidden","animate","setTimeout","destroy","shown","append","getFooter","find","hide","save","submitForm","submitFormAjax","show","formdata","params","jsonformdata","JSON","stringify","loadFragment","handleFormSubmissionResponse","Y","use","M","core_formchangechecker","reset_form_dirty_state","document","location","reload","handleFormSubmissionFailure","data","setBody","e","preventDefault","formData","serialize","call","methodname","done","fail","submit","load","positiontable","cfg","wwwroot","css","deleteposition","positiontype","deletemessage","get_strings","key","component","param","s","setSaveButtonText","value","button","asyncSet","text","confirm","ajax","method","dataType","url","success","window","href","getposition","orgID","val","customstrings","strings","template","html","template1","orgid","domainid","resp","alert","domainId"],"mappings":"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"}