/**
 * Add a create new group modal to the page.
 *
 * @module     local_courses/courseAjaxform
 * @class      courseAjaxform
 * @package    local_courses
 * @copyright  2018 Sreenivas
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_costcenter/fragment",["jquery","core/str","core/modal_factory","core/modal_events","core/fragment","core/ajax","core/yui","core/templates","core/notification","core/custom_interaction_events"],(function($,Str,ModalFactory,ModalEvents,fragment,Ajax,Y,Templates,Notification,CustomEvents){var SELECTORS_ELEMENT="[data-fg]",DATAATTRIBUTES_ELEFG="fg",DATAATTRIBUTES_PLUGIN="plugin",DATAATTRIBUTES_METHOD="method",DATAATTRIBUTES_PARAMS="params",Fragment=function(fgelement){this.contextid=M.cfg.contextid,this.fgelement=fgelement,this.id=fgelement.data("id")||0,this.pluginname=fgelement.data(DATAATTRIBUTES_PLUGIN),this.method=fgelement.data(DATAATTRIBUTES_METHOD),this.level=fgelement.data(DATAATTRIBUTES_ELEFG),this.args={},this.args.contextid=this.contextid,this.args.id=this.id;var params={};void 0!==fgelement.data(DATAATTRIBUTES_PARAMS)&&(params=fgelement.data(DATAATTRIBUTES_PARAMS)),this.args.params=JSON.stringify(params),this.init()};return Fragment.prototype.contextid=-1,Fragment.prototype.id=0,Fragment.prototype.level="c",Fragment.prototype.strings={},Fragment.prototype.args={},Fragment.prototype.init=function(){var self=this,stringsPromise=this.getStrings(),type=ModalFactory.types.SAVE_CANCEL;"r"==self.level&&(type=ModalFactory.types.DEFAULT);var modalPromise=ModalFactory.create({type:type});$.when(stringsPromise,modalPromise).then(function(strings,modal){this.modal=modal,this.modal.setTitle(strings[0]),this.modal.getRoot().on(ModalEvents.hidden,function(){this.modal.destroy()}.bind(this)),"d"==self.level?(this.modal.setBody(strings[1]),this.modal.getRoot().on(ModalEvents.save,(function(){self.deleteInstance()}))):(this.modal.setBody(this.getBody()),this.modal.setLarge(),this.modal.getRoot().on(ModalEvents.save,this.submitForm.bind(this)),this.modal.getRoot().on("submit","form",this.submitFormAjax.bind(this))),"evaluation_update_status"==self.method||"course_update_status"==self.method?this.modal.setSaveButtonText(strings[0]):"r"!=self.level&&this.modal.setSaveButtonText(strings[1]),this.modal.show(),this.modal.getRoot().on(ModalEvents.bodyRendered,function(){if("r"!=self.level||"peer_allocation_status"!=self.method&&"peer_badge_status"!=self.method){if("u"==self.level&&"addnew_question"==self.method){var params=JSON.parse(this.args.params),itemid=params.itemid,evalid=params.evalid;Ajax.call([{methodname:"local_evaluation_displayquestion",args:{itemid:itemid,evalid:evalid,typ:0}}])[0].done((function(resp){$("#displayform").html(resp.formdata)})).fail((function(){alert("Error occured while processing request")})),$("#select_question_type_survey").addClass("hidden")}}else;}.bind(this)),"c"!=self.level&&"u"!=self.level||"evaluation_update_status"==self.method||(self.modal.getRoot().addClass("openLMStransition costcenter"),this.modal.getRoot().animate({right:"0%"},500),this.modal.getRoot().on(ModalEvents.hidden,function(){this.modal.getRoot().animate({right:"-85%"},500),setTimeout((function(){modal.destroy()}),1e3)}.bind(this)))}.bind(this))},Fragment.prototype.getStrings=function(){var self=this,StringData=this.requiredStrings(),RequiredStrings=[],i=0;return $.each(StringData,(function(key,value){RequiredStrings[i]={key:key,component:self.pluginname,param:value},i++})),Str.get_strings(RequiredStrings)},Fragment.prototype.getBody=function(formdata){return void 0===formdata&&(formdata={}),this.args.jsonformdata=JSON.stringify(formdata),fragment.loadFragment(this.pluginname,this.method,this.contextid,this.args)},Fragment.prototype.handleFormSubmissionResponse=function(){this.modal.hide(),Y.use("moodle-core-formchangechecker",(function(){M.core_formchangechecker.reset_form_dirty_state()})),document.location.reload()},Fragment.prototype.handleFormSubmissionFailure=function(data){this.modal.setBody(this.getBody(data))},Fragment.prototype.submitFormAjax=function(e){e.preventDefault();var self=this,formData=this.modal.getRoot().find("form").serialize();this.args.jsonformdata=JSON.stringify(formData),Ajax.call([{methodname:this.pluginname+"_"+this.method,args:this.args}])[0].done((function(resp){resp.nextstep?(self.modal.destroy(),self.args.id=resp.id,self.init(self.fgelement),self.method=resp.method):self.handleFormSubmissionResponse(formData)})).fail((function(ex){self.handleFormSubmissionFailure(formData)}))},Fragment.prototype.submitForm=function(e){e.preventDefault(),this.modal.getRoot().find("form").submit()},Fragment.prototype.deleteInstance=function(){var self=this;Ajax.call([{methodname:this.pluginname+"_"+this.method,args:this.args}])[0].done((function(data){self.handleSubmissionResponse(data)})).fail((function(error){self.handleSubmissionFailure(error)}))},Fragment.prototype.handleSubmissionResponse=function(){this.modal.destroy(),Notification.addNotification({message:"Success",type:"success"}),"evaluation_update_status"!=this.method&&"course_update_status"!=this.method||(window.location.reload(),$("form#filteringform.mform #id_filter_apply").trigger("click"))},Fragment.prototype.handleSubmissionFailure=function(error){this.modal.destroy(),Notification.addNotification({message:error.message,type:"error"})},Fragment.prototype.requiredStrings=function(){var StringData={},PluginModule=require(this.pluginname+"/"+this.pluginname.split("_")[1]);switch("function"==typeof PluginModule.requiredStrings&&(StringData=PluginModule.requiredStrings(this)),this.method){case"addnew_question":switch(this.level){case"c":StringData.le_createnewquestion="le_createnewquestion",StringData.le_create="le_create";break;case"u":StringData.le_updatequestion="le_updatequestion",StringData.le_update="le_update"}break;case"evaluation_update_status":StringData.confirm="";var evalstatus=(localparams=JSON.parse(this.args.params)).eval_status,evalname=localparams.evalname;localparams.published;1==evalstatus?StringData.hideevaluation=evalname:StringData.showevaluation=evalname;break;case"course_update_status":StringData.courseconfirm="";var localparams,coursename=(localparams=JSON.parse(this.args.params)).coursename;1==localparams.coursestatus?StringData.disablecourse=coursename:StringData.enablecourse=coursename}return this.strings=StringData,StringData},{init:function(){$(document).on("click",SELECTORS_ELEMENT,(function(e){e.preventDefault();var fgelement=$(this);new Fragment(fgelement)}))}}}));

//# sourceMappingURL=fragment.min.js.map