{"version":3,"file":"competencies.min.js","sources":["../src/competencies.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Handle add/remove competency links.\n *\n * @module     local_competency/competencies\n * @package    local_competency\n * @copyright  2015 Damyon Wiese <damyon@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery',\n        'core/notification',\n        'core/ajax',\n        'core/templates',\n        'core/str',\n        'local_competency/competencypicker',\n        'local_competency/dragdrop-reorder'],\n       function($, notification, ajax, templates, str, Picker, dragdrop) {\n\n    /**\n     * Constructor\n     *\n     * @param {Number} itemid\n     * @param {String} itemtype\n     * @param {Number} pagectxid\n     */\n    var competencies = function(itemid, itemtype, pagectxid) {\n\n        console.log(itemid,itemtype,pagectxid);\n        this.itemid = itemid;\n        this.itemtype = itemtype;\n        this.pageContextId = pagectxid;\n        this.pickerInstance = null;\n\n        $('[data-region=\"actions\"] button').prop('disabled', false);\n        this.registerEvents();\n        this.registerDragDrop();\n    };\n\n    /**\n     * Initialise the drag/drop code.\n     * @method registerDragDrop\n     */\n    competencies.prototype.registerDragDrop = function() {\n        var localthis = this;\n        // Init this module.\n        str.get_string('movecompetency', 'local_competency').done(\n            function(movestring) {\n                dragdrop.dragdrop('movecompetency',\n                                  movestring,\n                                  {identifier: 'movecompetency', component: 'local_competency'},\n                                  {identifier: 'movecompetencyafter', component: 'local_competency'},\n                                  'drag-samenode',\n                                  'drag-parentnode',\n                                  'drag-handlecontainer',\n                                  function(drag, drop) {\n                                      localthis.handleDrop(drag, drop);\n                                  });\n            }\n        ).fail(notification.exception);\n\n    };\n\n    /**\n     * Handle a drop from a drag/drop operation.\n     *\n     * @method handleDrop\n     * @param {DOMNode} drag The dragged node.\n     * @param {DOMNode} drop The dropped on node.\n     */\n    competencies.prototype.handleDrop = function(drag, drop) {\n        var fromid = $(drag).data('id');\n        var toid = $(drop).data('id');\n        var localthis = this;\n        var requests = [];\n\n        if (localthis.itemtype == 'course') {\n            requests = ajax.call([\n                {\n                    methodname: 'core_competency_reorder_course_competency',\n                    args: {courseid: localthis.itemid, competencyidfrom: fromid, competencyidto: toid}\n                }\n            ]);\n        } else if (localthis.itemtype == 'template') {\n            requests = ajax.call([\n                {\n                    methodname: 'core_competency_reorder_template_competency',\n                    args: {templateid: localthis.itemid, competencyidfrom: fromid, competencyidto: toid}\n                }\n            ]);\n        } else if (localthis.itemtype == 'plan') {\n            requests = ajax.call([\n                {\n                    methodname: 'core_competency_reorder_plan_competency',\n                    args: {planid: localthis.itemid, competencyidfrom: fromid, competencyidto: toid}\n                }\n            ]);\n        } else {\n            return;\n        }\n\n        requests[0].fail(notification.exception);\n    };\n\n    /**\n     * Pick a competency\n     *\n     * @method pickCompetency\n     */\n    competencies.prototype.pickCompetency = function() {\n        var self = this;\n        var requests;\n        var pagerender;\n        var pageregion;\n        var pageContextIncludes;\n\n        if (!self.pickerInstance) {\n            if (self.itemtype === 'template' || self.itemtype === 'course') {\n                pageContextIncludes = 'parents';\n            }\n            self.pickerInstance = new Picker(self.pageContextId, false, pageContextIncludes);\n            self.pickerInstance.on('save', function(e, data) {\n                var compIds = data.competencyIds;\n\n                if (self.itemtype === \"course\") {\n                    requests = [];\n\n                    $.each(compIds, function(index, compId) {\n                        requests.push({\n                            methodname: 'core_competency_add_competency_to_course',\n                            args: {courseid: self.itemid, competencyid: compId}\n                        });\n                    });\n                    requests.push({\n                        methodname: 'local_competency_data_for_course_competencies_page',\n                        args: {courseid: self.itemid}\n                    });\n\n                    pagerender = 'local_competency/course_competencies_page';\n                    pageregion = 'coursecompetenciespage';\n\n                } else if (self.itemtype === \"template\") {\n                    requests = [];\n\n                    $.each(compIds, function(index, compId) {\n                        requests.push({\n                            methodname: 'core_competency_add_competency_to_template',\n                            args: {templateid: self.itemid, competencyid: compId}\n                        });\n                    });\n                    requests.push({\n                        methodname: 'local_competency_data_for_template_competencies_page',\n                        args: {templateid: self.itemid, pagecontext: {contextid: self.pageContextId}}\n                    });\n                    pagerender = 'local_competency/template_competencies_page';\n                    pageregion = 'templatecompetenciespage';\n                } else if (self.itemtype === \"plan\") {\n                    requests = [];\n\n                    $.each(compIds, function(index, compId) {\n                        requests.push({\n                            methodname: 'core_competency_add_competency_to_plan',\n                            args: {planid: self.itemid, competencyid: compId}\n                        });\n                    });\n                    requests.push({\n                         methodname: 'local_competency_data_for_plan_page',\n                         args: {planid: self.itemid}\n                    });\n                    pagerender = 'local_competency/plan_page';\n                    pageregion = 'plan-page';\n                }\n                ajax.call(requests)[requests.length - 1].then(function(context) {\n                    return templates.render(pagerender, context);\n                }).then(function(html, js) {\n                    $('[data-region=\"' + pageregion + '\"]').replaceWith(html);\n                    templates.runTemplateJS(js);\n                    return;\n                }).catch(notification.exception);\n            });\n        }\n\n        self.pickerInstance.display();\n    };\n\n    /**\n     * Delete the link between competency and course, template or plan. Reload the page.\n     *\n     * @method doDelete\n     * @param {int} deleteid The id of record to delete.\n     */\n    competencies.prototype.doDelete = function(deleteid) {\n        var localthis = this;\n        var requests = [],\n            pagerender = '',\n            pageregion = '';\n\n        // Delete the link and reload the page template.\n        if (localthis.itemtype == 'course') {\n            requests = ajax.call([\n                {methodname: 'core_competency_remove_competency_from_course',\n                    args: {courseid: localthis.itemid, competencyid: deleteid}},\n                {methodname: 'local_competency_data_for_course_competencies_page',\n                    args: {courseid: localthis.itemid}}\n            ]);\n            pagerender = 'local_competency/course_competencies_page';\n            pageregion = 'coursecompetenciespage';\n        } else if (localthis.itemtype == 'template') {\n            requests = ajax.call([\n                {methodname: 'core_competency_remove_competency_from_template',\n                    args: {templateid: localthis.itemid, competencyid: deleteid}},\n                {methodname: 'local_competency_data_for_template_competencies_page',\n                    args: {templateid: localthis.itemid, pagecontext: {contextid: localthis.pageContextId}}}\n            ]);\n            pagerender = 'local_competency/template_competencies_page';\n            pageregion = 'templatecompetenciespage';\n        } else if (localthis.itemtype == 'plan') {\n            requests = ajax.call([\n                {methodname: 'core_competency_remove_competency_from_plan',\n                    args: {planid: localthis.itemid, competencyid: deleteid}},\n                {methodname: 'local_competency_data_for_plan_page',\n                    args: {planid: localthis.itemid}}\n            ]);\n            pagerender = 'local_competency/plan_page';\n            pageregion = 'plan-page';\n        }\n\n        requests[1].done(function(context) {\n            templates.render(pagerender, context).done(function(html, js) {\n                $('[data-region=\"' + pageregion + '\"]').replaceWith(html);\n                templates.runTemplateJS(js);\n            }).fail(notification.exception);\n        }).fail(notification.exception);\n\n    };\n\n    /**\n     * Show a confirm dialogue before deleting a competency.\n     *\n     * @method deleteHandler\n     * @param {int} deleteid The id of record to delete.\n     */\n    competencies.prototype.deleteHandler = function(deleteid) {\n        var localthis = this;\n        var requests = [];\n        var message;\n\n        if (localthis.itemtype == 'course') {\n            message = 'unlinkcompetencycourse';\n        } else if (localthis.itemtype == 'template') {\n            message = 'unlinkcompetencytemplate';\n        } else if (localthis.itemtype == 'plan') {\n            message = 'unlinkcompetencyplan';\n        } else {\n            return;\n        }\n\n        requests = ajax.call([{\n            methodname: 'core_competency_read_competency',\n            args: {id: deleteid}\n        }]);\n\n        requests[0].done(function(competency) {\n            str.get_strings([\n                {key: 'confirm', component: 'moodle'},\n                {key: message, component: 'local_competency', param: competency.shortname},\n                {key: 'confirm', component: 'moodle'},\n                {key: 'cancel', component: 'moodle'}\n            ]).done(function(strings) {\n                notification.confirm(\n                    strings[0], // Confirm.\n                    strings[1], // Unlink the competency X from the course?\n                    strings[2], // Confirm.\n                    strings[3], // Cancel.\n                    function() {\n                        localthis.doDelete(deleteid);\n                    }\n                );\n            }).fail(notification.exception);\n        }).fail(notification.exception);\n    };\n\n    /**\n     * Register the javascript event handlers for this page.\n     *\n     * @method registerEvents\n     */\n    competencies.prototype.registerEvents = function() {\n        var localthis = this;\n\n        if (localthis.itemtype == 'course') {\n            // Course completion rule handling.\n            $('[data-region=\"coursecompetenciespage\"]').on('change', 'select[data-field=\"ruleoutcome\"]', function(e) {\n                var requests = [];\n                var pagerender = 'local_competency/course_competencies_page';\n                var pageregion = 'coursecompetenciespage';\n                var coursecompetencyid = $(e.target).data('id');\n                var ruleoutcome = $(e.target).val();\n                requests = ajax.call([\n                    {methodname: 'core_competency_set_course_competency_ruleoutcome',\n                      args: {coursecompetencyid: coursecompetencyid, ruleoutcome: ruleoutcome}},\n                    {methodname: 'local_competency_data_for_course_competencies_page',\n                      args: {courseid: localthis.itemid}}\n                ]);\n\n                requests[1].done(function(context) {\n                    templates.render(pagerender, context).done(function(html, js) {\n                        $('[data-region=\"' + pageregion + '\"]').replaceWith(html);\n                        templates.runTemplateJS(js);\n                    }).fail(notification.exception);\n                }).fail(notification.exception);\n            });\n        }\n\n        $('[data-region=\"actions\"] button').click(function(e) {\n            e.preventDefault();\n            localthis.pickCompetency();\n        });\n        $('[data-action=\"delete-competency-link\"]').click(function(e) {\n            e.preventDefault();\n\n            var deleteid = $(e.target).closest('[data-id]').data('id');\n            localthis.deleteHandler(deleteid);\n        });\n    };\n\n    return /** @alias module:local_competency/competencies */ competencies;\n});\n"],"names":["define","$","notification","ajax","templates","str","Picker","dragdrop","competencies","itemid","itemtype","pagectxid","console","log","pageContextId","pickerInstance","prop","registerEvents","registerDragDrop","prototype","localthis","this","get_string","done","movestring","identifier","component","drag","drop","handleDrop","fail","exception","fromid","data","toid","requests","call","methodname","args","courseid","competencyidfrom","competencyidto","templateid","planid","pickCompetency","pagerender","pageregion","pageContextIncludes","self","on","e","compIds","competencyIds","each","index","compId","push","competencyid","pagecontext","contextid","length","then","context","render","html","js","replaceWith","runTemplateJS","catch","display","doDelete","deleteid","deleteHandler","message","id","competency","get_strings","key","param","shortname","strings","confirm","coursecompetencyid","target","ruleoutcome","val","click","preventDefault","closest"],"mappings":"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"}