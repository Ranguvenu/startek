{"version":3,"file":"newforum.min.js","sources":["../src/newforum.js"],"sourcesContent":["/**\n * Add a create new group modal to the page.\n *\n * @module     local_forum/newforum\n * @class      newforum\n * @package    local_forum\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['local_courses/jquery.dataTables', 'jquery', 'core/str', 'core/modal_factory', 'core/modal_events', 'core/fragment', 'core/ajax', 'core/yui'],\n        function(DataTable, $, Str, ModalFactory, ModalEvents, Fragment, Ajax, Y) {\n \n    /**\n     * Constructor\n     *\n     * @param {String} selector used to find triggers for the new group modal.\n     * @param {int} contextid\n     *\n     * Each call to init gets it's own instance of this class.\n     */\n    var NewForum = function(args) {\n\n        this.contextid = args.context;\n        this.id = args.id;\n        var self = this;\n        this.args = args;\n        self.init(args);\n    };\n \n    /**\n     * @var {Modal} modal\n     * @private\n     */\n    NewForum.prototype.modal = null;\n \n    /**\n     * @var {int} contextid\n     * @private\n     */\n    NewForum.prototype.contextid = -1;\n \n    /**\n     * Initialise the class.\n     *\n     * @param {String} selector used to find triggers for the new group modal.\n     * @private\n     * @return {Promise}\n     */\n    NewForum.prototype.init = function(args) {\n        //var triggers = $(selector);\n        var self = this;\n        // Fetch the title string.\n            if (self.id) {\n                head =  Str.get_string('editforum', 'local_forum');\n            }else{\n               head =  Str.get_string('forum:addinstance', 'local_forum');\n            }\n            return head.then(function(title) {\n                // Create the modal.\n                return ModalFactory.create({\n                type: ModalFactory.types.DEFAULT,\n                title: title,\n                body: this.getBody(),\n                footer: this.getFooter(),\n                });\n            }.bind(this)).then(function(modal) {\n                // Keep a reference to the modal.\n                this.modal = modal;\n                // self.modal.show();\n                // Forms are big, we want a big modal.\n                this.modal.setLarge(); \n                \n                this.modal.getRoot().addClass('openLMStransition');\n\n                // this.modal.getRoot().on(ModalEvents.hidden, function() {\n                //     this.modal.setBody('');\n                this.modal.getRoot().on(ModalEvents.hidden, function() {\n                    this.modal.getRoot().animate({\"right\":\"-85%\"}, 500);\n                    setTimeout(function(){\n                        modal.destroy();\n                    }, 1000);\n                }.bind(this));\n\n                this.modal.getFooter().find('[data-action=\"save\"]').on('click', this.submitForm.bind(this));\n                // We also catch the form submit event and use it to submit the form with ajax.\n\n                // this.modal.getFooter().find('[data-action=\"cancel\"]').on('click', function() {\n                //     modal.setBody('');\n                //     modal.hide();\n                this.modal.getFooter().find('[data-action=\"cancel\"]').on('click', function() {\n                    modal.hide();\n                    setTimeout(function(){\n                        modal.destroy();\n                    }, 1000);\n                     //modal.destroy();\n                    if (args.form_status !== 0 ) {\n                        window.location.reload();\n                    }\n                });\n                this.modal.getRoot().find('[data-action=\"hide\"]').on('click', function() {\n                    modal.hide();\n                    setTimeout(function(){\n                        modal.destroy();\n                    }, 1000);\n                     //modal.destroy();\n                    if (args.form_status !== 0 ) {\n                        window.location.reload();\n                    }\n                });\n\n                this.modal.getRoot().on('submit', 'form', function(form) {\n                    self.submitFormAjax(form, self.args);\n                });\n                this.modal.show();\n                this.modal.getRoot().animate({\"right\":\"0%\"}, 500);\n\n                return this.modal;\n            }.bind(this));       \n        \n        \n        // });\n        \n    };\n \n    /**\n     * @method getBody\n     * @private\n     * @return {Promise}\n     */\n    NewForum.prototype.getBody = function(formdata) {\n        if (typeof formdata === \"undefined\") {\n            formdata = {};\n        }\n        // Get the content of the modal.\n        this.args.jsonformdata = JSON.stringify(formdata);\n        return Fragment.loadFragment('local_forum', 'new_forum_form', this.contextid, this.args);\n    };\n    /**\n     * @method getFooter\n     * @private\n     * @return {Promise}\n     */\n    NewForum.prototype.getFooter = function() {\n        $footer = '<button type=\"button\" class=\"btn btn-primary\" data-action=\"save\">'+M.util.get_string(\"save_continue\", \"local_forum\")+'</button>&nbsp;';\n        $style = 'style=\"display:none;\"';\n        //$footer += '<button type=\"button\" class=\"btn btn-secondary\" data-action=\"skip\" ' + $style + ' >Skip</button>&nbsp;';\n        $footer += '<button type=\"button\" class=\"btn btn-secondary\" data-action=\"cancel\">'+M.util.get_string(\"cancel\", \"moodle\")+'</button>';\n        return $footer;\n    };\n \n    /**\n     * @method handleFormSubmissionResponse\n     * @private\n     * @return {Promise}\n     */\n    NewForum.prototype.handleFormSubmissionResponse = function(args) {\n        this.modal.hide();\n        // We could trigger an event instead.\n        Y.use('moodle-core-formchangechecker', function() {\n            M.core_formchangechecker.reset_form_dirty_state();\n        });\n        document.location.reload();\n        //var modalPromise = ModalFactory.create({\n        //    type: ModalFactory.types.DEFAULT,\n        //    body: this.getBody(),\n        //});\n        //$.when(modalPromise).then(function(modal) {\n        //\n        //    modal.show();\n        //    return modal;\n        //}).fail(Notification.exception);\n    };\n \n    /**\n     * @method handleFormSubmissionFailure\n     * @private\n     * @return {Promise}\n     */\n    NewForum.prototype.handleFormSubmissionFailure = function(data) {\n         // We need to re-display the form with errors!\n        this.modal.setBody(this.getBody(data));\n    };\n \n    /**\n     * Private method\n     *\n     * @method submitFormAjax\n     * @private\n     * @param {Event} e Form submission event.\n     */\n    NewForum.prototype.submitFormAjax = function(e ,args) {\n        // We don't want to do a real form submission.\n        e.preventDefault();\n        var self = this;\n        // Convert all the form elements values to a serialised string.\n        var formData = this.modal.getRoot().find('form').serialize();\n        var methodname = 'local_forum_submit_create_forum_form';\n        var params = {};\n        params.contextid = this.contextid;\n        params.form_status = args.form_status;\n        params.jsonformdata = JSON.stringify(formData);\n        \n\n        var promise = Ajax.call([{\n            methodname: methodname,\n            args: params\n        }]);\n         promise[0].done(function(resp){\n            // alert(resp.form_status);\n            if(resp.form_status !== -1 && resp.form_status !== false) {\n                self.args.form_status = resp.form_status;\n                self.args.id = resp.id;\n                self.handleFormSubmissionFailure();\n                if (resp.form_status == 2) {\n                    //code\n                     self.handleFormSubmissionResponse(self.args);\n                }\n            } else {\n                self.handleFormSubmissionResponse(self.args);\n            }\n            if(args.form_status > 0) {\n                $('[data-action=\"skip\"]').css('display', 'inline-block');\n            }\n        }).fail(function(ex){\n            self.handleFormSubmissionFailure(formData);\n        });\n\n    };\n \n    /**\n     * This triggers a form submission, so that any mform elements can do final tricks before the form submission is processed.\n     *\n     * @method submitForm\n     * @param {Event} e Form submission event.\n     * @private\n     */\n    NewForum.prototype.submitForm = function(e) {\n        e.preventDefault();\n        var self = this;\n        self.modal.getRoot().find('form').submit();\n    };\n \n    return {\n        // Public variables and functions.\n        /**\n         * Attach event listeners to initialise this module.\n         * @method init\n         * @param {args} \n         */\n        init: function(args) {\n            $(document).on('change', '#id_costcenterid', function() {\n                \n                var costcentervalue = $(this).find(\"option:selected\").val();\n                title = M.util.get_string(\"all\", \"moodle\");\n                if (costcentervalue !== null) {\n                    $.ajax({\n                        method: \"GET\",\n                        dataType: \"json\",\n                        url: M.cfg.wwwroot + \"/local/forum/dept_ajax.php?action=departmentlist&costcenter=\"+costcentervalue,\n                        success: function(data){\n                            var depttemplate = '<option value=\"\">'+title+'</option>';\n                              $.each( data.data, function( index, value) {\n                                   depttemplate +=\t'<option value = ' + index + ' >' +value + '</option>';\n                                });\n                            $(\"#id_departmentid\").html(depttemplate);\n                        }\n                    });\n                    grptitle = M.util.get_string(\"all\", \"moodle\");\n                    $.ajax({\n                        method: \"GET\",\n                        dataType: \"json\",\n                        url: M.cfg.wwwroot + \"/local/forum/dept_ajax.php?action=groupslist&costcenter=\"+costcentervalue,\n                        success: function(data){\n                            var template = '<option value=\"\">'+grptitle+'</option>';\n                              $.each( data.data, function( index, value) {\n                                   template +=\t'<option value = ' + index + ' >' +value+ '</option>';\n                              });\n                            $(\"#id_local_group\").html(template);\n                        }\n                    });\n                }\n            });\n            \n            $(document).on('change', '#id_departmentid', function() {\n                //var departmentvalue = $(this).find(\"option:selected\").val();\n                var departmentvalue = $('#id_departmentid').val();\n                title = M.util.get_string(\"all\", \"moodle\");\n                //if (departmentvalue !== null && !isNaN(parseInt(departmentvalue, 10))) {\n                if (departmentvalue !== null) {\n                    if(departmentvalue > 0){\n                        var costcentervalue = 0;\n                    }else{\n                        var costcentervalue = $('#id_costcenterid').val();\n                    }\n                    $.ajax({\n                        method: \"GET\",\n                        dataType: \"json\",\n                        url: M.cfg.wwwroot + \"/local/forum/dept_ajax.php?action=groupslist&costcenter=\"+costcentervalue+\"&department=\"+departmentvalue,\n                        success: function(data){\n                            var template = '<option value=\"\">'+title+'</option>';\n                                $.each( data.data, function( index, value) {\n                                     template +=\t'<option value = ' + index + ' >' +value+ '</option>';\n                                });\n                            $(\"#id_local_group\").html(template);\n                        }\n                    });\n                }\n            });\n            return new NewForum(args);\n        },\n        load: function(){},\n        deleteforum: function(elem) {\n            return Str.get_strings([{\n                key: 'delete',\n                component: 'local_forum'\n            }, {\n                key: 'deleteforum',\n                component: 'local_forum'\n            }]).then(function(s) {\n                ModalFactory.create({\n                    title: s[0],\n                    type: ModalFactory.types.DEFAULT,\n                    body: s[1],\n                    footer: '<button type=\"button\" class=\"btn btn-primary\" data-action=\"save\">'+M.util.get_string(\"yes\", \"moodle\")+'</button>&nbsp;' +\n        '<button type=\"button\" class=\"btn btn-secondary\" data-action=\"cancel\">'+M.util.get_string(\"no\", \"moodle\")+'</button>'\n                }).done(function(modal) {\n                    this.modal = modal;\n                    modal.getRoot().find('[data-action=\"save\"]').on('click', function() {\n                        window.location.href ='index.php?id='+elem+'&delete=1&sesskey=' + M.cfg.sesskey;\n                    }.bind(this));\n                    modal.getFooter().find('[data-action=\"cancel\"]').on('click', function() {\n                        modal.setBody('');\n                        modal.hide();\n                    });\n                    modal.show();\n                }.bind(this));\n            }.bind(this));\n        },\n        load_datatable :function(tableid){\n            return Str.get_strings([{\n                key: 'noforums',\n                component: 'local_forum'\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\tkey: 'search',\n                component: 'local_forum'\n\t\t\t\t}\n\t\t\t\n\t\t\t]).then(function(s) {\n                $('#'+tableid).DataTable({\n                    'language': {\n                        \"zeroRecords\": s[0],\n                        'infoEmpty': s[0],\n                        'paginate': {\n                            'previous': '<',\n                            'next': '>'\n                        }\n                    },\n\t\t\t\t\t\"oLanguage\": {\n\t\t\t\t\t\"sSearch\": s[1]\n\t\t\t\t },\n                    order: []\n                });\n            });\n        },\n        \n    };\n});"],"names":["define","DataTable","$","Str","ModalFactory","ModalEvents","Fragment","Ajax","Y","NewForum","args","contextid","context","id","this","init","prototype","modal","self","head","get_string","then","title","create","type","types","DEFAULT","body","getBody","footer","getFooter","bind","setLarge","getRoot","addClass","on","hidden","animate","setTimeout","destroy","find","submitForm","hide","form_status","window","location","reload","form","submitFormAjax","show","formdata","jsonformdata","JSON","stringify","loadFragment","$footer","M","util","$style","handleFormSubmissionResponse","use","core_formchangechecker","reset_form_dirty_state","document","handleFormSubmissionFailure","data","setBody","e","preventDefault","formData","serialize","params","call","methodname","done","resp","css","fail","ex","submit","costcentervalue","val","ajax","method","dataType","url","cfg","wwwroot","success","depttemplate","each","index","value","html","grptitle","template","departmentvalue","load","deleteforum","elem","get_strings","key","component","s","href","sesskey","load_datatable","tableid","order"],"mappings":"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"}