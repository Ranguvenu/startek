/**
 * Add a create new group modal to the page.
 *
 * @module     local_forum/courseAjaxform
 * @class      courseAjaxform
 * @package    local_forum
 * @copyright  2018 Sreenivas
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later 
 */
define("local_forum/forumAjaxform",["local_courses/jquery.dataTables","jquery","core/str","core/modal_factory","core/modal_events","core/fragment","core/ajax","core/yui","core/templates"],(function(dataTable,$,Str,ModalFactory,ModalEvents,Fragment,Ajax,Y,Templates){var courseAjaxform=function(args){this.contextid=args.contextid?args.contextid:1,this.args=args,this.init(args)};return courseAjaxform.prototype.modal=null,courseAjaxform.prototype.contextid=-1,courseAjaxform.prototype.init=function(args){var self=this;if(args.courseid)var head={key:"editforum",component:"local_forum"};else head={key:"createforum",component:"local_forum"};return customstrings=Str.get_strings([head,{key:"yes",component:"customfield"},{key:"no",component:"customfield"},{key:"saveandcontinue",component:"local_forum"},{key:"cancel",component:"moodle"}]),customstrings.then(function(strings){return ModalFactory.create({type:ModalFactory.types.DEFAULT,title:strings[0],body:this.getBody(),footer:this.getFooter(strings)})}.bind(this)).then(function(modal){return this.modal=modal,"custom_selfcompletion_form"!=args.callback&&(this.modal.setLarge(),this.modal.getRoot().addClass("openLMStransition local_courses"),this.modal.getRoot().on(ModalEvents.hidden,function(){this.modal.getRoot().animate({right:"-85%"},500),setTimeout((function(){modal.destroy()}),1e3),this.modal.setBody("")}.bind(this))),this.modal.footer.find('[data-action="save"]').on("click",this.submitForm.bind(this)),this.modal.getFooter().find('[data-action="cancel"]').on("click",(function(){modal.setBody(""),modal.hide(),setTimeout((function(){modal.destroy()}),1e3),0!==args.form_status&&window.location.reload()})),this.modal.getRoot().find('[data-action="hide"]').on("click",(function(){modal.hide(),setTimeout((function(){modal.destroy()}),1e3),0!==args.form_status&&window.location.reload()})),"custom_forum_form"==self.args.callback&&$(document).on("click",".custom_forum_form_redirect",(function(){if($("#forumid").val()>0){self.args.form_status=$(this).data("value");var data=self.getBody();data.then((function(html,js){!1===html&&self.handleFormSubmissionResponse(args)})),modal.setBody(data)}})),this.modal.getRoot().on("submit","form",(function(form){self.submitFormAjax(form,self.args)})),this.modal.show(),this.modal.getRoot().animate({right:"0%"},500),this.modal}.bind(this))},courseAjaxform.prototype.getBody=function(formdata){return void 0===formdata&&(formdata={}),this.args.jsonformdata=JSON.stringify(formdata),Fragment.loadFragment(this.args.component,this.args.callback,this.contextid,this.args)},courseAjaxform.prototype.getFooter=function(customstrings){var footer="";return"userview"!=this.args.viewtype&&(footer+='<button type="button" class="btn btn-primary" data-action="save">'+customstrings[3]+"</button>&nbsp;",footer+='<button type="button" class="btn btn-secondary" data-action="cancel">'+customstrings[4]+"</button>"),footer},courseAjaxform.prototype.getcontentFooter=function(){return Str.get_strings([{key:"cancel"}]).then(function(s){return $footer='<button type="button" class="btn btn-secondary" data-action="cancel">'+s[0]+"</button>",$footer}.bind(this))},courseAjaxform.prototype.handleFormSubmissionResponse=function(args){if(this.modal.hide(),Y.use("moodle-core-formchangechecker",(function(){M.core_formchangechecker.reset_form_dirty_state()})),!args.userid)return Str.get_strings([{key:"forumoverview",component:"local_forum"}]).then(function(s){var context={courseid:args.courseid,configpath:M.cfg.wwwroot,enrolid:args.enrolid,contextid:args.contextid},modalPromise=ModalFactory.create({type:ModalFactory.types.DEFAULT,body:Templates.render("local_forum/forum",context),footer:this.getcontentFooter()});$.when(modalPromise).then((function(modal){return modal.setTitle(s[0]),modal.setLarge(),modal.getRoot().addClass("openLMStransition"),modal.show(),modal.getRoot().animate({right:"0%"},500),modal.getRoot().on(ModalEvents.hidden,function(){modal.destroy()}.bind(this)),modal.getFooter().find('[data-action="cancel"]').on("click",(function(){modal.getRoot().animate({right:"-85%"},500),setTimeout((function(){window.location.reload()}),600)})),modal.getRoot().find('[data-action="hide"]').on("click",(function(){modal.getRoot().animate({right:"-85%"},500),setTimeout((function(){window.location.reload()}),200)})),modal})).fail(Notification.exception),$("#coursesearch").dataTable().destroy()}.bind(this));this.modal.hide()},courseAjaxform.prototype.handleFormSubmissionFailure=function(data){this.modal.setBody(this.getBody(data))},courseAjaxform.prototype.submitFormAjax=function(e,args){e.preventDefault();var self=this,formData=this.modal.getRoot().find("form").serialize();if(args.userid)var methodname=args.plugintype+"_"+args.pluginname+"_submit_evidence_forum_form";else methodname=args.plugintype+"_"+args.pluginname+"_submit_create_forum_form";var params={};params.contextid=this.contextid,params.jsonformdata=JSON.stringify(formData),params.form_status=args.form_status,Ajax.call([{methodname:methodname,args:params}])[0].done((function(resp){self.args.courseid=resp.courseid,self.args.enrolid=resp.enrolid,-1!==resp.form_status&&!1!==resp.form_status?(self.args.form_status=resp.form_status,self.handleFormSubmissionFailure()):self.handleFormSubmissionResponse(self.args)})).fail((function(){self.handleFormSubmissionFailure(formData)}))},courseAjaxform.prototype.submitForm=function(e){e.preventDefault(),this.modal.getRoot().find("form").submit()},{init:function(args){return new courseAjaxform(args)},deleteConfirm:function(args){return Str.get_strings([{key:"confirm"},{key:"deleteconfirm",component:"local_forum",param:args},{key:"deleteallconfirm",component:"local_forum"},{key:"delete"},{key:"yes",component:"customfield"},{key:"no",component:"customfield"}]).then(function(s){ModalFactory.create({title:s[0],type:ModalFactory.types.DEFAULT,body:s[1],footer:'<button type="button" class="btn btn-primary" data-action="save">'+s[4]+'</button>&nbsp;<button type="button" class="btn btn-secondary" data-action="cancel">'+s[5]+"</button>"}).done(function(modal){this.modal=modal,modal.getRoot().find('[data-action="save"]').on("click",function(){args.confirm=!0,Ajax.call([{methodname:"local_forum_"+args.action,args:args}])[0].done((function(){window.location.href=window.location.href})).fail((function(ex){console.log(ex)}))}.bind(this)),modal.getFooter().find('[data-action="cancel"]').on("click",(function(){modal.setBody(""),modal.hide()})),modal.show()}.bind(this))}.bind(this))},getCatlist:function(){},load:function(){}}}));

//# sourceMappingURL=forumAjaxform.min.js.map