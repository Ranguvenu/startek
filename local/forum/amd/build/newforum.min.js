/**
 * Add a create new group modal to the page.
 *
 * @module     local_forum/newforum
 * @class      newforum
 * @package    local_forum
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_forum/newforum",["local_courses/jquery.dataTables","jquery","core/str","core/modal_factory","core/modal_events","core/fragment","core/ajax","core/yui"],(function(DataTable,$,Str,ModalFactory,ModalEvents,Fragment,Ajax,Y){var NewForum=function(args){this.contextid=args.context,this.id=args.id;this.args=args,this.init(args)};return NewForum.prototype.modal=null,NewForum.prototype.contextid=-1,NewForum.prototype.init=function(args){var self=this;return self.id?head=Str.get_string("editforum","local_forum"):head=Str.get_string("forum:addinstance","local_forum"),head.then(function(title){return ModalFactory.create({type:ModalFactory.types.DEFAULT,title:title,body:this.getBody(),footer:this.getFooter()})}.bind(this)).then(function(modal){return this.modal=modal,this.modal.setLarge(),this.modal.getRoot().addClass("openLMStransition"),this.modal.getRoot().on(ModalEvents.hidden,function(){this.modal.getRoot().animate({right:"-85%"},500),setTimeout((function(){modal.destroy()}),1e3)}.bind(this)),this.modal.getFooter().find('[data-action="save"]').on("click",this.submitForm.bind(this)),this.modal.getFooter().find('[data-action="cancel"]').on("click",(function(){modal.hide(),setTimeout((function(){modal.destroy()}),1e3),0!==args.form_status&&window.location.reload()})),this.modal.getRoot().find('[data-action="hide"]').on("click",(function(){modal.hide(),setTimeout((function(){modal.destroy()}),1e3),0!==args.form_status&&window.location.reload()})),this.modal.getRoot().on("submit","form",(function(form){self.submitFormAjax(form,self.args)})),this.modal.show(),this.modal.getRoot().animate({right:"0%"},500),this.modal}.bind(this))},NewForum.prototype.getBody=function(formdata){return void 0===formdata&&(formdata={}),this.args.jsonformdata=JSON.stringify(formdata),Fragment.loadFragment("local_forum","new_forum_form",this.contextid,this.args)},NewForum.prototype.getFooter=function(){return $footer='<button type="button" class="btn btn-primary" data-action="save">'+M.util.get_string("save_continue","local_forum")+"</button>&nbsp;",$style='style="display:none;"',$footer+='<button type="button" class="btn btn-secondary" data-action="cancel">'+M.util.get_string("cancel","moodle")+"</button>",$footer},NewForum.prototype.handleFormSubmissionResponse=function(args){this.modal.hide(),Y.use("moodle-core-formchangechecker",(function(){M.core_formchangechecker.reset_form_dirty_state()})),document.location.reload()},NewForum.prototype.handleFormSubmissionFailure=function(data){this.modal.setBody(this.getBody(data))},NewForum.prototype.submitFormAjax=function(e,args){e.preventDefault();var self=this,formData=this.modal.getRoot().find("form").serialize(),params={};params.contextid=this.contextid,params.form_status=args.form_status,params.jsonformdata=JSON.stringify(formData),Ajax.call([{methodname:"local_forum_submit_create_forum_form",args:params}])[0].done((function(resp){-1!==resp.form_status&&!1!==resp.form_status?(self.args.form_status=resp.form_status,self.args.id=resp.id,self.handleFormSubmissionFailure(),2==resp.form_status&&self.handleFormSubmissionResponse(self.args)):self.handleFormSubmissionResponse(self.args),args.form_status>0&&$('[data-action="skip"]').css("display","inline-block")})).fail((function(ex){self.handleFormSubmissionFailure(formData)}))},NewForum.prototype.submitForm=function(e){e.preventDefault();this.modal.getRoot().find("form").submit()},{init:function(args){return $(document).on("change","#id_costcenterid",(function(){var costcentervalue=$(this).find("option:selected").val();title=M.util.get_string("all","moodle"),null!==costcentervalue&&($.ajax({method:"GET",dataType:"json",url:M.cfg.wwwroot+"/local/forum/dept_ajax.php?action=departmentlist&costcenter="+costcentervalue,success:function(data){var depttemplate='<option value="">'+title+"</option>";$.each(data.data,(function(index,value){depttemplate+="<option value = "+index+" >"+value+"</option>"})),$("#id_departmentid").html(depttemplate)}}),grptitle=M.util.get_string("all","moodle"),$.ajax({method:"GET",dataType:"json",url:M.cfg.wwwroot+"/local/forum/dept_ajax.php?action=groupslist&costcenter="+costcentervalue,success:function(data){var template='<option value="">'+grptitle+"</option>";$.each(data.data,(function(index,value){template+="<option value = "+index+" >"+value+"</option>"})),$("#id_local_group").html(template)}}))})),$(document).on("change","#id_departmentid",(function(){var departmentvalue=$("#id_departmentid").val();if(title=M.util.get_string("all","moodle"),null!==departmentvalue){if(departmentvalue>0)var costcentervalue=0;else costcentervalue=$("#id_costcenterid").val();$.ajax({method:"GET",dataType:"json",url:M.cfg.wwwroot+"/local/forum/dept_ajax.php?action=groupslist&costcenter="+costcentervalue+"&department="+departmentvalue,success:function(data){var template='<option value="">'+title+"</option>";$.each(data.data,(function(index,value){template+="<option value = "+index+" >"+value+"</option>"})),$("#id_local_group").html(template)}})}})),new NewForum(args)},load:function(){},deleteforum:function(elem){return Str.get_strings([{key:"delete",component:"local_forum"},{key:"deleteforum",component:"local_forum"}]).then(function(s){ModalFactory.create({title:s[0],type:ModalFactory.types.DEFAULT,body:s[1],footer:'<button type="button" class="btn btn-primary" data-action="save">'+M.util.get_string("yes","moodle")+'</button>&nbsp;<button type="button" class="btn btn-secondary" data-action="cancel">'+M.util.get_string("no","moodle")+"</button>"}).done(function(modal){this.modal=modal,modal.getRoot().find('[data-action="save"]').on("click",function(){window.location.href="index.php?id="+elem+"&delete=1&sesskey="+M.cfg.sesskey}.bind(this)),modal.getFooter().find('[data-action="cancel"]').on("click",(function(){modal.setBody(""),modal.hide()})),modal.show()}.bind(this))}.bind(this))},load_datatable:function(tableid){return Str.get_strings([{key:"noforums",component:"local_forum"},{key:"search",component:"local_forum"}]).then((function(s){$("#"+tableid).DataTable({language:{zeroRecords:s[0],infoEmpty:s[0],paginate:{previous:"<",next:">"}},oLanguage:{sSearch:s[1]},order:[]})}))}}}));

//# sourceMappingURL=newforum.min.js.map