/**
 * Add a create new group modal to the page.
 *
 * @module     block_gamification/gamification
 * @class      gamification
 * @package    block_gamification
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("block_gamification/gamification",["local_courses/jquery.dataTables","jquery","core/str","core/modal_factory","core/modal_events","core/fragment","core/ajax","core/yui"],(function(dataTable,$,Str,ModalFactory,ModalEvents,Fragment,Ajax){var levelsform=function(args){this.contextid=args.contextid;this.args=args,this.init(args)};levelsform.prototype.modal=null,levelsform.prototype.contextid=-1,levelsform.prototype.init=function(args){var self=this;if(this.args.configid>0&&(self.configid=this.args.configid),self.configid)var head=Str.get_string("editlevels","block_gamification");else head=Str.get_string("addnewlevels","block_gamification");return head.then(function(title){return ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:title,body:self.getBody()})}.bind(self)).then(function(modal){return self.modal=modal,self.modal.getRoot().addClass("openLMStransition local_costcenter"),self.modal.setLarge(),self.modal.getRoot().on(ModalEvents.hidden,function(){self.modal.setBody(self.getBody()),self.modal.getRoot().animate({right:"-85%"},500),setTimeout((function(){modal.destroy()}),1e3)}.bind(this)),self.modal.getRoot().on(ModalEvents.shown,function(){self.modal.getRoot().append("<style>[data-fieldtype=submit] { display: none ! important; }</style>")}.bind(this)),self.modal.getRoot().on(ModalEvents.save,self.submitForm.bind(self)),self.modal.getRoot().on("submit","form",self.submitFormAjax.bind(self)),this.modal.show(),this.modal.getRoot().animate({right:"0%"},500),this.modal}.bind(this))},levelsform.prototype.getBody=function(formdata){void 0===formdata&&(formdata={});var params={costcenterid:this.args.costcenterid,levels:this.args.levels,enabled:this.args.enabled,jsonformdata:JSON.stringify(formdata)};return Fragment.loadFragment("block_gamification","levelsform",this.contextid,params)},levelsform.prototype.handleFormSubmissionResponse=function(){this.modal.hide(),Y.use("moodle-core-formchangechecker",(function(){M.core_formchangechecker.reset_form_dirty_state()})),document.location.reload()},levelsform.prototype.handleFormSubmissionFailure=function(data){this.modal.setBody(this.getBody(data))},levelsform.prototype.submitFormAjax=function(e){e.preventDefault();var formData=this.modal.getRoot().find("form").serialize();Ajax.call([{methodname:"block_gamification_submit_levels_form",args:{contextid:this.contextid,jsonformdata:JSON.stringify(formData)},done:this.handleFormSubmissionResponse.bind(this,formData),fail:this.handleFormSubmissionFailure.bind(this,formData)}])},levelsform.prototype.submitForm=function(e){e.preventDefault();this.modal.getRoot().find("form").submit()};var displaylevelscontent=function(args){var self=this;return Str.get_string("leveldconfigdata","block_gamification",self).then(function(title){return ModalFactory.create({type:ModalFactory.types.CANCEL,title:title,body:self.getlevelbody(args)})}.bind(self)).then(function(modal){return self.modal=modal,self.modal.show(),self.modal.setLarge(),self.modal.getRoot().on(ModalEvents.hidden,function(){self.modal.setBody("")}.bind(this)),self.modal.getRoot().on(ModalEvents.shown,function(){self.modal.getRoot().append("<style>[data-fieldtype=submit] { display: none ! important; }</style>")}.bind(this)),self.modal.getRoot().on(ModalEvents.save,self.submitForm.bind(self)),self.modal.getRoot().on("submit","form",self.submitFormAjax.bind(self)),this.modal}.bind(this))};displaylevelscontent.prototype.getlevelbody=function(args){return Fragment.loadFragment("block_gamification","levelscontent",1,args)};var displayLevelUserPopup=function(args){var self=this;return Str.get_string("levelusersdata","block_gamification",args).then(function(title){return ModalFactory.create({type:ModalFactory.types.DEFAULT,title:title,body:self.getlevelusersbody(args)})}.bind(self)).then(function(modal){return self.modal=modal,self.modal.show(),self.modal.setLarge(),self.modal.getRoot().on(ModalEvents.hidden,function(){self.modal.setBody("")}.bind(this)),self.modal.getRoot().on(ModalEvents.shown,function(){self.modal.getRoot().append("<style>[data-fieldtype=submit] { display: none ! important; }</style>")}.bind(this)),self.modal.getRoot().on(ModalEvents.save,self.submitForm.bind(self)),self.modal.getRoot().on("submit","form",self.submitFormAjax.bind(self)),this.modal}.bind(this))};displayLevelUserPopup.prototype.getlevelusersbody=function(args){return Fragment.loadFragment("block_gamification","levelsuserscontent",1,args)};return{load:function(){},levelsform:function(){$(document).on("click",".submitlevels",(function(){var levelsid=$(this).attr("id"),levels=$("."+levelsid).val(),maxlevels=$(this).data("maxlevels");if(levels>maxlevels)$(".errorlevel"+levelsid).removeClass("hidden"),Str.get_string("maximum_number_of_levels","block_gamificationy").then((function(maxleveltext){$(".errorlevel"+levelsid).html(maxleveltext+" "+maxlevels)}));else{if(levels>=2){var costcenterid=$("."+levelsid).data("costcenterid"),configid=$("."+levelsid).data("configid");return args={costcenterid:costcenterid,contextid:1,enabled:1,levels:levels,configid:configid},new levelsform(args)}$(".errorlevel"+levelsid).removeClass("hidden"),levels&&levels<2?Str.get_string("minimum_number_of_levels","block_gamificationy").then((function(minleveltext){$(".errorlevel"+levelsid).html(minleveltext)})):Str.get_string("levelsmandatory","block_gamificationy").then((function(levelsmandatory){$(".errorlevel"+levelsid).html(levelsmandatory)}))}})),$(document).on("change",".levelvalue",(function(){var costcenterid=$(this).data("costcenterid");$(".errorlevelsubmit"+costcenterid).hasClass("hidden")||$(".errorlevelsubmit"+costcenterid).addClass("hidden")})),$(document).on("click",".displaylevels",(function(){var costcenterid=$(this).data("costcenterid");return args={costcenterid:costcenterid},new displaylevelscontent(args)})),$(document).on("click",".leveluserdisplaypopup",(function(){if($(this).data("value")){var costcenterid=$(this).data("costcenterid"),level=$(this).data("level");return args={costcenterid:costcenterid,level:level},new displayLevelUserPopup(args)}}))},badgespreview:function(){$(document).on("change","#badgeaccountselect",(function(){var costcenter=$(this).find("option:selected").val();$.ajax({method:"GET",dataType:"json",url:M.cfg.wwwroot+"/blocks/gamification/customajax.php?action=get_costcenter_badges&costcenter="+costcenter,success:function(data){$("#badges_container").html(data)}})}))},config_datatables:function(){$("#config_table").dataTable({searching:!0,pageLength:5,responsive:!0,bLengthChange:!1,aaSorting:[],oLanguage:{oPaginate:{sNext:" > ",bStateSave:!0,sPrevious:" < "}}})},ruleDefinationValidate:function(){$(".block-gamification-filters").on("submit",(function(e){if(!skipClientValidation){var returnval=!0;return $(".custom_gamification_rule").each((function(index,value){var element;$(value).hasClass("ruletype_grade")?flag=function(element){$(element);var flag1=flag2=flag3=!0,lowervalue=$(element).find(".lowervalue_element").val();""==lowervalue?($(element).find(".error_lowervalue_element").show(),flag1=!1):$(element).find(".error_lowervalue_element").hide();var uppervalue=$(element).find(".uppervalue_element").val();return""==uppervalue?($(element).find(".error_uppervalue_element").show(),flag2=!1):$(element).find(".error_uppervalue_element").hide(),null==$(element).find(".select.custom-select").val()?($(element).find(".error_completion_setting").show(),flag3=!1):$(element).find(".error_completion_setting").hide(),console.log(""==lowervalue),console.log(typeof uppervalue),console.log(lowervalue),console.log(uppervalue),console.log(flag1&&flag2&&parseInt(lowervalue)>parseInt(uppervalue)),flag1&&flag2&&parseInt(lowervalue)>parseInt(uppervalue)?($(element).find(".error_range_element_mismatch").show(),flag1=!1,flag2=!1):$(element).find(".error_range_element_mismatch").hide(),flag1&&flag2&&flag3}(value):$(value).hasClass("ruletype_completetion")&&(flag=null!=$(element=value).find(".select.custom-select").val()?($(element).find(".error_completion_setting").hide(),!0):($(element).find(".error_completion_setting").show(),!1),console.log(flag)),console.log("flag"),console.log(flag),flag||(returnval=!1,console.log(returnval))})),returnval}window.location.reload()}))}}}));

//# sourceMappingURL=gamification.min.js.map