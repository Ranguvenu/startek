define("block_learnerscript/schedule",["jquery","core/ajax","block_learnerscript/ajax","core/event","block_learnerscript/select2","block_learnerscript/report","core/str"],(function($,Ajax,ajax,Event,select2,report,Str){return schedule={schreportform:function(args){Ajax.call([{methodname:"block_learnerscript_schreportform",args:{reportid:args.reportid,instance:args.instanceid}}])[0].done((function(response){response=$.parseJSON(response),$("body").append("<div class='schreportform"+args.instanceid+"'>"+response+"</div>");var title_img="<img class='dialog_title_icon' alt='Scheduled Report' src='"+M.util.image_url("schedule_icon","block_learnerscript")+"'/>";$(".schreportform"+args.instanceid).dialog({resizable:!0,autoOpen:!1,width:"90%",title:"Add schedule report",modal:!0,appendTo:"#inst"+args.instanceid,position:{my:"center",at:"center",of:"#reportcontainer"+args.instanceid},open:function(event,ui){$(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-close").html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");var Closebutton=$(".ui-icon-closethick").parent();$(Closebutton).attr({title:"Close"}),$(this).closest(".ui-dialog").find(".ui-dialog-title").html(title_img+"Schedule report")},close:function(event,ui){$(this).dialog("destroy").remove()}}).dialog("open"),$("#id_role"+args.instanceid).select2(),this.SelectRoleUsers(),this.schformvalidation({reportid:args.reportid,form:"schform"+args.instanceid,reqclass:"schformreq"+args.instanceid,instanceid:args.instanceid})})).fail((function(ex){}))},ScheduledTimings:function(args){$("select[data-select2='1']").select2({theme:"classic"}),this.SelectRoleUsers(),$("#scheduledtimings").dataTable({processing:!0,serverSide:!0,lengthMenu:[[5,10,25,50,-1],[5,10,25,50,"All"]],idisplaylength:5,ordering:!1,ajax:{method:"GET",url:M.cfg.wwwroot+"/blocks/learnerscript/components/scheduler/ajax.php",data:args}})},ViewSchUsersTable:function(args){$("#scheduledusers").dataTable({processing:!0,serverSide:!0,lengthMenu:[[5,10,25,50,-1],[5,10,25,50,"All"]],idisplaylength:5,ordering:!1,ajax:{method:"GET",url:M.cfg.wwwroot+"/blocks/learnerscript/components/scheduler/ajax.php",data:{action:"viewschusersdata",reportid:args.reportid,scheduleid:args.scheduleid,schuserslist:args.schuserslist}}})},schformvalidation:function(args){document.getElementById(args.form).addEventListener("submit",(function(ev){try{var myValidator=report.validate_scheduled_reports_form(args)}catch(e){return!0}return void 0!==window.tinyMCE&&window.tinyMCE.triggerSave(),myValidator||ev.preventDefault(),!1}))},validate_scheduled_reports_form:function(args){var self=this;skipClientValidation&&$(".schreportform"+args.instanceid).dialog("destroy").remove();var ret=!0,first_focus=(document.getElementById(args.form),!1);return $("[data-class='"+args.reqclass+"']").each((function(index,value){var element=$(value).data("element");(ret=self.validate_scheduled_reports_form_element(value,element,args)&&ret)||first_focus||(first_focus=!0,Y.use("moodle-core-event",(function(){Y.Global.fire(M.core.globalEvents.FORM_ERROR,{formid:args.form,elementid:"id_error_"+element+args.instanceid}),document.getElementById("id_error_"+element+args.instanceid).focus()})))})),ret},validate_scheduled_reports_form_element:function(element,escapedName,args){if(null==element)return!0;var value="",errFlag=new Array,_qfMsg="",frm=element.parentNode;if(null!=element.name&&null!=frm){for(;frm&&"FORM"!=frm.nodeName.toUpperCase();)frm=frm.parentNode;value=new Array;for(var valueIdx=0,i=0;i<element.options.length;i++)element.options[i].selected&&(value[valueIdx++]=element.options[i].value);return""!=value||errFlag[escapedName]||(errFlag[escapedName]=!0,_qfMsg+=" - You must supply a value here."),this.qf_errorHandler(element,_qfMsg,escapedName,args)}return!0},qf_errorHandler:function(element,_qfMsg,escapedName,args){var event=$.Event(Event.Events.FORM_FIELD_VALIDATION);if($(element).trigger(event,_qfMsg),event.isDefaultPrevented())return""==_qfMsg;var div=element.parentNode;if(null==div||null==element.name)return!0;if(""!=_qfMsg){var errorSpan;for((errorSpan=document.getElementById("id_error_"+escapedName+args.instanceid))||((errorSpan=document.createElement("span")).id="id_error_"+escapedName+args.instanceid,errorSpan.className="error",element.parentNode.insertBefore(errorSpan,element.parentNode.firstChild),document.getElementById(errorSpan.id).setAttribute("TabIndex","0"),document.getElementById(errorSpan.id).focus());errorSpan.firstChild;)errorSpan.removeChild(errorSpan.firstChild);return errorSpan.appendChild(document.createTextNode(_qfMsg.substring(3)))," error"!=div.className.substr(div.className.length-6,6)&&"error"!=div.className&&(div.className+=" error",(linebreak=document.createElement("br")).className="error",linebreak.id="id_error_break_"+escapedName+args.instanceid,errorSpan.parentNode.insertBefore(linebreak,errorSpan.nextSibling)),!1}(errorSpan=document.getElementById("id_error_"+escapedName+args.instanceid))&&errorSpan.parentNode.removeChild(errorSpan);var linebreak=document.getElementById("id_error_break_"+escapedName+args.instanceid);return linebreak&&linebreak.parentNode.removeChild(linebreak)," error"==div.className.substr(div.className.length-6,6)?div.className=div.className.substr(0,div.className.length-6):"error"==div.className&&(div.className=""),!0},frequency_schedule:function(args){Ajax.call([{methodname:"block_learnerscript_frequency_schedule",args:{frequency:$("#id_frequency"+args.reportinstance).val()}}])[0].done((function(resp){resp=$.parseJSON(resp);var template="";resp?$.each(resp,(function(index,value){template+="<option value = "+index+" >"+value+"</option>"})):template+="<option value=null > --SELECT-- </option>",$("#id_updatefrequency"+args.reportinstance).html(template)})).fail((function(ex){}))},manageschusers:function(args){Str.get_string("manageschusers","block_learnerscript").then((function(s){Ajax.call([{methodname:"block_learnerscript_manageschusers",args:{reportid:args.reportid,scheduleid:args.scheduleid,selectedroleid:JSON.stringify(args.selectedroleid),schuserslist:args.schuserslist,reportinstance:args.reportinstance}}])[0].done((function(response){var position,my,at;if(response=$.parseJSON(response),$("body").append("<div class='manageschusers'>"+response+"</div>"),"page-blocks-learnerscript-components-scheduler-schedule"==$("body").attr("id"))position="#scheduleform",my="center top",at="center top";else{position=window,my="center",at="center";$(".manageschusers").addClass("notschuserspage")}var dlg=$(".manageschusers").dialog({resizable:!0,autoOpen:!1,width:"60%",title:"Manage Schedule Users",modal:!0,position:{my:my,at:at,of:position,within:position},close:function(event,ui){$(this).dialog("destroy").remove()},open:function(){$(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-close").html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");var Closebutton=$(".ui-icon-closethick").parent();$(Closebutton).attr({title:"Close"})}});$(".manageschusers").hasClass("notschuserspage")&&$(".manageschusers").parent().addClass("notinschpage");$(".selectrole"+args.reportid).select2(),dlg.dialog("open")})).fail((function(ex){}))}))},getroleusers:function(args){var roles=$(".selectrole"+args.reportid).val();this.validate_scheduled_reports_form({reportid:args.reportid,form:"assignform",reqclass:"rolereq"});var bullkselectedusers=$(".removeselect").val();$("#addselect_searchtext").val().length<1?(template="<optgroup label='Enter a value in search.'></optgroup>",$("#"+args.type+"select"+args.reportid).html("<optgroup label='Enter a value in search.'></optgroup>")):Ajax.call([{methodname:"block_learnerscript_roleusers",args:{term:$("#addselect_searchtext").val(),type:args.type,reportid:args.reportid,roleid:JSON.stringify(roles),scheduleid:args.scheduleid,bullkselectedusers:JSON.stringify(bullkselectedusers)}}])[0].done((function(response){var template="";(response=$.parseJSON(response)).total_count>0?$.each(response.items,(function(index,value){template+="<option value = "+value.id+" >"+value.fullname+"</option>"})):template+="<optgroup label='No results found.'></optgroup>",$("#"+args.type+"select"+args.reportid).html(template)})).fail((function(ex){}))},bulkmanageschusers:function(args){var bullkselectedusers=$.map($(".removeselect option"),(function(e){return e.value}));$("#schuserslist"+args.reportinstance).val(bullkselectedusers);var selectedusers=$(".removeselect").find("option").clone();if($("#id_users_data"+args.reportinstance).children("option").remove(),selectedusers.length>10){selectedusers.slice(0,10).attr("selected","selected").appendTo("#id_users_data"+args.reportinstance);var opt=document.createElement("option");opt.value="-1",opt.innerHTML="View More",opt.selected=!0,document.getElementById("id_users_data"+args.reportinstance).appendChild(opt)}else $(".removeselect").find("option").clone().attr("selected","selected").appendTo("#id_users_data"+args.reportinstance);$(".manageschusers").dialog("close")},viewschusers:function(args){Str.get_string("viewschusers","block_learnerscript").then((function(s){args.schuserslist=$("#schuserslist"+args.reportinstance).val(),ajax.call({methodname:"viewschuserstable",args:{action:"viewschuserstable",reportid:args.reportid,scheduleid:args.scheduleid,schuserslist:args.schuserslist},url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"}).done((function(response){$("body").append("<div class='viewschuserstable'>"+response+"</div>");var dlg=$(".viewschuserstable").dialog({resizable:!0,autoOpen:!1,width:"60%",title:"View Scheduled Users",modal:!0,close:function(event,ui){$(this).dialog("destroy").remove()},open:function(){$(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-close").html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");var Closebutton=$(".ui-icon-closethick").parent();$(Closebutton).attr({title:"Close"})}});schedule.ViewSchUsersTable(args),dlg.dialog("open").prev(".ui-dialog-titlebar").css("color","#0C75B6")})).fail((function(ex){}))}))},addschusers:function(args){var total,selschusers=$(".schforms"+args.reportinstance+" #id_users_data"+args.reportinstance).val(),selusers=$(".schforms"+args.reportinstance+" #schuserslist"+args.reportinstance).val();if(selusers?(selusers=selusers.split(","),total=selusers.concat(selschusers)):total=selschusers,total&&total.includes("-1")){var index=total.indexOf("-1");total.splice(index,1)}$("#id_users_data"+args.reportinstance).find("option").not(":selected").each((function(k,v){if(total&&total.includes(v.value)){var index=total.indexOf(v.value);total.splice(index,1)}}));var d=total&&total.filter((function(item,pos){return total.indexOf(item)==pos}));$("#schuserslist"+args.reportinstance).val(d)},SelectRoleUsers:function(){var reportid=$(".schform").data("reportid");require(["block_learnerscript/helper"],(function(helper){helper.Select2Ajax({reportid:reportid,action:"rolewiseusers",maximumSelectionLength:10})}))},rolewiseusers:function(args){$("#id_users_data"+args.reportinstance).val(null).trigger("change")},organizationdepartments:function(args){var organizationid=$("#id_organization").val();$("#id_department");organizationid>0&&ajax.call({args:{action:"orgdepts",basicparam:!0,orgid:organizationid},url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"}).done((function(response){var template="";$.each(response,(function(key,value){template+="<option value = "+key+"  >"+value+"</option>"})),$("#id_department").html(template);var currentdepartment=$("#id_department").find(":selected").val();0!=currentdepartment&&null!=currentdepartment||$("#id_department").val($("#id_department option:eq(1)").val()),$("#id_department").trigger("change")}))},deptsubdepartment:function(args){var departmentid=$("#id_department").val();departmentid>0&&ajax.call({args:{action:"deptsubdepartments",basicparam:!0,departmentid:departmentid},url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"}).done((function(response){var template="";$.each(response,(function(key,value){template+="<option value = "+key+"  >"+value+"</option>"})),$("#id_subdepartment").html(template);var currentsubdepartment=$("#id_subdepartment").find(":selected").val();0!=currentsubdepartment&&null!=currentsubdepartment||$("#id_subdepartment").val($("#id_subdepartment option:eq(1)").val()),$("#id_subdepartment").trigger("change")}))}}}));

//# sourceMappingURL=schedule.min.js.map