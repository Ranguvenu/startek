{"version":3,"file":"inplace_editable.min.js","sources":["../src/inplace_editable.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AJAX helper for the inline editing a value.\n *\n * This script is automatically included from template core/inplace_editable\n * It registers a click-listener on [data-inplaceeditablelink] link (the \"inplace edit\" icon),\n * then replaces the displayed value with an input field. On \"Enter\" it sends a request\n * to web service core_update_inplace_editable, which invokes the specified callback.\n * Any exception thrown by the web service (or callback) is displayed as an error popup.\n *\n * @module     core/inplace_editable\n * @package    core\n * @copyright  2016 Marina Glancy\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.1\n */\ndefine(['jquery', 'core/ajax', 'core/templates', 'core/notification', 'core/str', 'core/config', 'core/url'],\n        function($, ajax, templates, notification, str, cfg, url) {\n\n    $('body').on('click keypress', '[data-inplaceeditable] [data-inplaceeditablelink]', function(e) {\n        if (e.type === 'keypress' && e.keyCode !== 13) {\n            return;\n        }\n        e.stopImmediatePropagation();\n        e.preventDefault();\n        var target = $(this),\n            mainelement = target.closest('[data-inplaceeditable]');\n\n        var addSpinner = function(element) {\n            element.addClass('updating');\n            var spinner = element.find('img.spinner');\n            if (spinner.length) {\n                spinner.show();\n            } else {\n                spinner = $('<img/>')\n                        .attr('src', url.imageUrl('i/loading_small'))\n                        .addClass('spinner').addClass('smallicon')\n                    ;\n                element.append(spinner);\n            }\n        };\n\n        var removeSpinner = function(element) {\n            element.removeClass('updating');\n            element.find('img.spinner').hide();\n        };\n\n        var updateValue = function(mainelement, value) {\n            addSpinner(mainelement);\n            ajax.call([{\n                    methodname: 'block_reportdashboard_inplace_editable_dashboard',\n                    args: {\n                        prevoiusdashboardname: mainelement.attr('data-prevoiusdashboardname'),\n                        pagetypepattern: mainelement.attr('data-pagetypepattern'),\n                        subpagepattern: mainelement.attr('data-subpagepattern'),\n                        // component: mainelement.attr('data-component'),\n                        // itemtype: mainelement.attr('data-itemtype'),\n                        value: value\n                    },\n                    done: function(data) {\n                        var roleshortname = mainelement.attr('data-roleshortname');\n\n                        // templates.render('core/inplace_editable', data).done(function(html, js) {\n                        //     var newelement = $(html);\n                        //     templates.replaceNode(mainelement, newelement, js);\n                        //     newelement.find('[data-inplaceeditablelink]').focus();\n                        //     newelement.trigger({type: 'updated', ajaxreturn: data, oldvalue: oldvalue});\n                        // });\n                        if(roleshortname == ''){\n                            window.location.href = M.cfg.wwwroot+'/blocks/reportdashboard/dashboard.php?dashboardurl='+data;\n                        } else{\n                            window.location.href = M.cfg.wwwroot+'/blocks/reportdashboard/dashboard.php?dashboardurl='+data+'&role='+roleshortname;\n                        }\n                    },\n                    fail: function(ex) {\n                        var e = $.Event('updatefailed', {\n                                exception: ex,\n                                newvalue: value\n                            });\n                        removeSpinner(mainelement);\n                        mainelement.trigger(e);\n                        if (!e.isDefaultPrevented()) {\n                            notification.exception(ex);\n                        }\n                    }\n                }], true);\n        };\n\n        var turnEditingOff = function(el) {\n            el.find('input').off();\n            el.find('select').off();\n            el.html(el.attr('data-oldcontent'));\n            el.removeAttr('data-oldcontent');\n            el.removeClass('inplaceeditingon');\n            el.find('[data-inplaceeditablelink]').focus();\n        };\n\n        var turnEditingOffEverywhere = function() {\n            $('span.inplaceeditable.inplaceeditingon').each(function() {\n                turnEditingOff($(this));\n            });\n        };\n\n        var uniqueId = function(prefix, idlength) {\n            var uniqid = prefix,\n                i;\n            for (i = 0; i < idlength; i++) {\n                uniqid += String(Math.floor(Math.random() * 10));\n            }\n            // Make sure this ID is not already taken by an existing element.\n            if ($(\"#\" + uniqid).length === 0) {\n                return uniqid;\n            }\n            return uniqueId(prefix, idlength);\n        };\n\n        var turnEditingOnText = function(el) {\n            str.get_string('edittitleinstructions').done(function(s) {\n                var instr = $('<span class=\"editinstructions\">' + s + '</span>').\n                        attr('id', uniqueId('id_editinstructions_', 20)),\n                    inputelement = $('<input type=\"text\"/>').\n                        attr('id', uniqueId('id_inplacevalue_', 20)).\n                        attr('value', el.attr('data-value')).\n                        attr('aria-describedby', instr.attr('id')).\n                        addClass('ignoredirty').\n                        addClass('form-control'),\n                    lbl = $('<label class=\"accesshide\">' + mainelement.attr('data-editlabel') + '</label>').\n                        attr('for', inputelement.attr('id'));\n                el.html('').append(instr).append(lbl).append(inputelement);\n\n                inputelement.focus();\n                inputelement.select();\n                inputelement.on('keyup keypress focusout', function(e) {\n                    if (cfg.behatsiterunning && e.type === 'focusout') {\n                        // Behat triggers focusout too often.\n                        return;\n                    }\n                    if (e.type === 'keypress' && e.keyCode === 13) {\n                        // We need 'keypress' event for Enter because keyup/keydown would catch Enter that was\n                        // pressed in other fields.\n                        var val = inputelement.val();\n                        turnEditingOff(el);\n                        updateValue(el, val);\n                    }\n                    if ((e.type === 'keyup' && e.keyCode === 27) || e.type === 'focusout') {\n                        // We need 'keyup' event for Escape because keypress does not work with Escape.\n                        turnEditingOff(el);\n                    }\n                });\n            });\n        };\n\n        var turnEditingOnToggle = function(el, newvalue) {\n            turnEditingOff(el);\n            updateValue(el, newvalue);\n        };\n\n        var turnEditingOnSelect = function(el, options) {\n            var i,\n                inputelement = $('<select></select>').\n                    attr('id', uniqueId('id_inplacevalue_', 20)).\n                    addClass('custom-select'),\n                lbl = $('<label class=\"accesshide\">' + mainelement.attr('data-editlabel') + '</label>')\n                    .attr('for', inputelement.attr('id'));\n            for (i in options) {\n                inputelement\n                    .append($('<option>')\n                    .attr('value', options[i].key)\n                    .html(options[i].value));\n            }\n            inputelement.val(el.attr('data-value'));\n            el.html('')\n                .append(lbl)\n                .append(inputelement);\n\n            inputelement.focus();\n            inputelement.select();\n            inputelement.on('keyup change focusout', function(e) {\n                if (cfg.behatsiterunning && e.type === 'focusout') {\n                    // Behat triggers focusout too often.\n                    return;\n                }\n                if (e.type === 'change') {\n                    var val = inputelement.val();\n                    turnEditingOff(el);\n                    updateValue(el, val);\n                }\n                if ((e.type === 'keyup' && e.keyCode === 27) || e.type === 'focusout') {\n                    // We need 'keyup' event for Escape because keypress does not work with Escape.\n                    turnEditingOff(el);\n                }\n            });\n        };\n\n        var turnEditingOn = function(el) {\n            el.addClass('inplaceeditingon');\n            el.attr('data-oldcontent', el.html());\n\n            var type = el.attr('data-type');\n            var options = el.attr('data-options');\n\n            if (type === 'toggle') {\n                turnEditingOnToggle(el, options);\n            } else if (type === 'select') {\n                turnEditingOnSelect(el, $.parseJSON(options));\n            } else {\n                turnEditingOnText(el);\n            }\n        };\n\n        // Turn editing on for the current element and register handler for Enter/Esc keys.\n        turnEditingOffEverywhere();\n        turnEditingOn(mainelement);\n\n    });\n\n    return {};\n});\n"],"names":["define","$","ajax","templates","notification","str","cfg","url","on","e","type","keyCode","stopImmediatePropagation","preventDefault","mainelement","this","closest","updateValue","value","element","addClass","spinner","find","length","show","attr","imageUrl","append","addSpinner","call","methodname","args","prevoiusdashboardname","pagetypepattern","subpagepattern","done","data","roleshortname","window","location","href","M","wwwroot","fail","ex","Event","exception","newvalue","removeClass","hide","trigger","isDefaultPrevented","turnEditingOff","el","off","html","removeAttr","focus","uniqueId","prefix","idlength","i","uniqid","String","Math","floor","random","each","options","turnEditingOnToggle","inputelement","lbl","key","val","select","behatsiterunning","turnEditingOnSelect","parseJSON","get_string","s","instr","turnEditingOnText","turnEditingOn"],"mappings":"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"}